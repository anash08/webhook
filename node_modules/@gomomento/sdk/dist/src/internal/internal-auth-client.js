"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.permissionsFromScope = exports.InternalAuthClient = void 0;
const generated_types_1 = require("@gomomento/generated-types");
var grpcAuth = generated_types_1.auth.auth;
const headers_interceptor_1 = require("./grpc/headers-interceptor");
const client_timeout_interceptor_1 = require("./grpc/client-timeout-interceptor");
const grpc_js_1 = require("@grpc/grpc-js");
const package_json_1 = require("../../package.json");
const cache_service_error_mapper_1 = require("../errors/cache-service-error-mapper");
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
var Never = grpcAuth._GenerateApiTokenRequest.Never;
var Expires = grpcAuth._GenerateApiTokenRequest.Expires;
const sdk_core_1 = require("@gomomento/sdk-core");
const errors_1 = require("@gomomento/sdk-core/dist/src/errors");
const token_scope_1 = require("@gomomento/sdk-core/dist/src/auth/tokens/token-scope");
class InternalAuthClient {
    constructor(props) {
        this.creds = props.credentialProvider;
        const headers = [new headers_interceptor_1.Header('Agent', `nodejs:${package_json_1.version}`)];
        this.interceptors = [
            new headers_interceptor_1.HeaderInterceptorProvider(headers).createHeadersInterceptor(),
            (0, client_timeout_interceptor_1.ClientTimeoutInterceptor)(InternalAuthClient.REQUEST_TIMEOUT_MS),
        ];
    }
    async generateAuthToken(scope, expiresIn) {
        const authClient = new grpcAuth.AuthClient(this.creds.getControlEndpoint(), grpc_js_1.ChannelCredentials.createSsl());
        let permissions;
        try {
            permissions = permissionsFromScope(scope);
        }
        catch (err) {
            return new sdk_core_1.GenerateAuthToken.Error((0, errors_1.normalizeSdkError)(err));
        }
        const request = new grpcAuth._GenerateApiTokenRequest({
            auth_token: this.creds.getAuthToken(),
            permissions: permissions,
        });
        if (expiresIn.doesExpire()) {
            try {
                (0, utils_1.validateValidForSeconds)(expiresIn.seconds());
            }
            catch (err) {
                return new sdk_core_1.GenerateAuthToken.Error((0, errors_1.normalizeSdkError)(err));
            }
            request.expires = new Expires({
                valid_for_seconds: expiresIn.seconds(),
            });
        }
        else {
            request.never = new Never();
        }
        return await new Promise(resolve => {
            authClient.GenerateApiToken(request, { interceptors: this.interceptors }, (err, resp) => {
                if (err || !resp) {
                    resolve(new sdk_core_1.GenerateAuthToken.Error((0, cache_service_error_mapper_1.cacheServiceErrorMapper)(err)));
                }
                else {
                    resolve(new sdk_core_1.GenerateAuthToken.Success(resp.api_key, resp.refresh_token, resp.endpoint, sdk_core_1.ExpiresAt.fromEpoch(resp.valid_until)));
                }
            });
        });
    }
    async refreshAuthToken(refreshToken) {
        const authClient = new grpcAuth.AuthClient(this.creds.getControlEndpoint(), grpc_js_1.ChannelCredentials.createSsl());
        const request = new grpcAuth._RefreshApiTokenRequest({
            api_key: this.creds.getAuthToken(),
            refresh_token: refreshToken,
        });
        return await new Promise(resolve => {
            authClient.RefreshApiToken(request, { interceptors: this.interceptors }, (err, resp) => {
                if (err || !resp) {
                    resolve(new sdk_core_1.RefreshAuthToken.Error((0, cache_service_error_mapper_1.cacheServiceErrorMapper)(err)));
                }
                else {
                    resolve(new sdk_core_1.RefreshAuthToken.Success(resp.api_key, resp.refresh_token, resp.endpoint, sdk_core_1.ExpiresAt.fromEpoch(resp.valid_until)));
                }
            });
        });
    }
}
exports.InternalAuthClient = InternalAuthClient;
InternalAuthClient.REQUEST_TIMEOUT_MS = 60 * 1000;
function permissionsFromScope(scope) {
    const result = new grpcAuth._GenerateApiTokenRequest.Permissions();
    if (scope instanceof utils_1.InternalSuperUserPermissions) {
        result.super_user =
            grpcAuth._GenerateApiTokenRequest.SuperUserPermissions.SuperUser;
        return result;
    }
    else if ((0, token_scope_1.isPermissionsObject)(scope)) {
        const scopePermissions = (0, token_scope_1.asPermissionsObject)(scope);
        const explicitPermissions = new grpcAuth._GenerateApiTokenRequest.ExplicitPermissions();
        explicitPermissions.permissions = scopePermissions.permissions.map(p => tokenPermissionToGrpcPermission(p));
        result.explicit = explicitPermissions;
        return result;
    }
    throw new Error(`Unrecognized token scope: ${JSON.stringify(scope)}`);
}
exports.permissionsFromScope = permissionsFromScope;
function tokenPermissionToGrpcPermission(permission) {
    const result = new grpcAuth._GenerateApiTokenRequest.PermissionsType();
    if ((0, token_scope_1.isTopicPermission)(permission)) {
        result.topic_permissions = topicPermissionToGrpcPermission((0, token_scope_1.asTopicPermission)(permission));
        return result;
    }
    else if ((0, token_scope_1.isCachePermission)(permission)) {
        result.cache_permissions = cachePermissionToGrpcPermission((0, token_scope_1.asCachePermission)(permission));
        return result;
    }
    throw new Error(`Unrecognized token permission: ${JSON.stringify(permission)}`);
}
function topicPermissionToGrpcPermission(permission) {
    const grpcPermission = new grpcAuth._GenerateApiTokenRequest.PermissionsType.TopicPermissions();
    switch (permission.role) {
        case sdk_core_1.TopicRole.PublishSubscribe: {
            grpcPermission.role =
                grpcAuth._GenerateApiTokenRequest.TopicRole.TopicReadWrite;
            break;
        }
        case sdk_core_1.TopicRole.SubscribeOnly: {
            grpcPermission.role =
                grpcAuth._GenerateApiTokenRequest.TopicRole.TopicReadOnly;
            break;
        }
        default: {
            throw new Error(`Unrecognized topic role: ${JSON.stringify(permission)}`);
        }
    }
    if (permission.cache === sdk_core_1.AllCaches) {
        grpcPermission.all_caches =
            new grpcAuth._GenerateApiTokenRequest.PermissionsType.All();
    }
    else if (typeof permission.cache === 'string') {
        grpcPermission.cache_selector =
            new grpcAuth._GenerateApiTokenRequest.PermissionsType.CacheSelector({
                cache_name: permission.cache,
            });
    }
    else if ((0, sdk_core_1.isCacheName)(permission.cache)) {
        grpcPermission.cache_selector =
            new grpcAuth._GenerateApiTokenRequest.PermissionsType.CacheSelector({
                cache_name: permission.cache.name,
            });
    }
    else {
        throw new Error(`Unrecognized cache specification in topic permission: ${JSON.stringify(permission)}`);
    }
    if (permission.topic === sdk_core_1.AllTopics) {
        grpcPermission.all_topics =
            new grpcAuth._GenerateApiTokenRequest.PermissionsType.All();
    }
    else if (typeof permission.topic === 'string') {
        grpcPermission.topic_selector =
            new grpcAuth._GenerateApiTokenRequest.PermissionsType.TopicSelector({
                topic_name: permission.topic,
            });
    }
    else if ((0, sdk_core_1.isTopicName)(permission.topic)) {
        grpcPermission.topic_selector =
            new grpcAuth._GenerateApiTokenRequest.PermissionsType.TopicSelector({
                topic_name: permission.topic.name,
            });
    }
    else {
        throw new Error(`Unrecognized topic specification in topic permission: ${JSON.stringify(permission)}`);
    }
    return grpcPermission;
}
function cachePermissionToGrpcPermission(permission) {
    const grpcPermission = new grpcAuth._GenerateApiTokenRequest.PermissionsType.CachePermissions();
    switch (permission.role) {
        case sdk_core_1.CacheRole.ReadWrite: {
            grpcPermission.role =
                grpcAuth._GenerateApiTokenRequest.CacheRole.CacheReadWrite;
            break;
        }
        case sdk_core_1.CacheRole.ReadOnly: {
            grpcPermission.role =
                grpcAuth._GenerateApiTokenRequest.CacheRole.CacheReadOnly;
            break;
        }
        default: {
            throw new Error(`Unrecognized cache role: ${JSON.stringify(permission)}`);
        }
    }
    if (permission.cache === sdk_core_1.AllCaches) {
        grpcPermission.all_caches =
            new grpcAuth._GenerateApiTokenRequest.PermissionsType.All();
    }
    else if (typeof permission.cache === 'string') {
        grpcPermission.cache_selector =
            new grpcAuth._GenerateApiTokenRequest.PermissionsType.CacheSelector({
                cache_name: permission.cache,
            });
    }
    else if ((0, sdk_core_1.isCacheName)(permission.cache)) {
        grpcPermission.cache_selector =
            new grpcAuth._GenerateApiTokenRequest.PermissionsType.CacheSelector({
                cache_name: permission.cache.name,
            });
    }
    else {
        throw new Error(`Unrecognized cache specification in cache permission: ${JSON.stringify(permission)}`);
    }
    return grpcPermission;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZXJuYWwtYXV0aC1jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvaW50ZXJuYWwvaW50ZXJuYWwtYXV0aC1jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsZ0VBQWdEO0FBQ2hELElBQU8sUUFBUSxHQUFHLHNCQUFJLENBQUMsSUFBSSxDQUFDO0FBQzVCLG9FQUE2RTtBQUM3RSxrRkFBMkU7QUFDM0UsMkNBQThEO0FBQzlELHFEQUEyQztBQUMzQyxxRkFBNkU7QUFDN0UsdUVBR3FEO0FBQ3JELElBQU8sS0FBSyxHQUFHLFFBQVEsQ0FBQyx3QkFBd0IsQ0FBQyxLQUFLLENBQUM7QUFDdkQsSUFBTyxPQUFPLEdBQUcsUUFBUSxDQUFDLHdCQUF3QixDQUFDLE9BQU8sQ0FBQztBQUMzRCxrREFpQjZCO0FBRzdCLGdFQUFzRTtBQUN0RSxzRkFPOEQ7QUFFOUQsTUFBYSxrQkFBa0I7SUFNN0IsWUFBWSxLQUFzQjtRQUNoQyxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQztRQUN0QyxNQUFNLE9BQU8sR0FBRyxDQUFDLElBQUksNEJBQU0sQ0FBQyxPQUFPLEVBQUUsVUFBVSxzQkFBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzNELElBQUksQ0FBQyxZQUFZLEdBQUc7WUFDbEIsSUFBSSwrQ0FBeUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyx3QkFBd0IsRUFBRTtZQUNqRSxJQUFBLHFEQUF3QixFQUFDLGtCQUFrQixDQUFDLGtCQUFrQixDQUFDO1NBQ2hFLENBQUM7SUFDSixDQUFDO0lBRU0sS0FBSyxDQUFDLGlCQUFpQixDQUM1QixLQUFpQixFQUNqQixTQUFvQjtRQUVwQixNQUFNLFVBQVUsR0FBRyxJQUFJLFFBQVEsQ0FBQyxVQUFVLENBQ3hDLElBQUksQ0FBQyxLQUFLLENBQUMsa0JBQWtCLEVBQUUsRUFDL0IsNEJBQWtCLENBQUMsU0FBUyxFQUFFLENBQy9CLENBQUM7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Q0FBQyx3QkFBd0IsQ0FBQyxlQUFlLENBQUMsR0FBRyxFQUFFLENBQUM7S0FDL0Q7U0FBTSxJQUFJLE9BQU8sVUFBVSxDQUFDLEtBQUssS0FBSyxRQUFRLEVBQUU7UUFDL0MsY0FBYyxDQUFDLGNBQWM7WUFDM0IsSUFBSSxRQUFRLENBQUMsd0JBQXdCLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FBQztnQkFDbEUsVUFBVSxFQUFFLFVBQVUsQ0FBQyxLQUFLO2FBQzdCLENBQUMsQ0FBQztLQUNOO1NBQU0sSUFBSSxJQUFBLHNCQUFXLEVBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQ3hDLGNBQWMsQ0FBQyxjQUFjO1lBQzNCLElBQUksUUFBUSxDQUFDLHdCQUF3QixDQUFDLGVBQWUsQ0FBQyxhQUFhLENBQUM7Z0JBQ2xFLFVBQVUsRUFBRSxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUk7YUFDbEMsQ0FBQyxDQUFDO0tBQ047U0FBTTtRQUNMLE1BQU0sSUFBSSxLQUFLLENBQ2IseURBQXlELElBQUksQ0FBQyxTQUFTLENBQ3JFLFVBQVUsQ0FDWCxFQUFFLENBQ0osQ0FBQztLQUNIO0lBQ0QsT0FBTyxjQUFjLENBQUM7QUFDeEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7YXV0aH0gZnJvbSAnQGdvbW9tZW50by9nZW5lcmF0ZWQtdHlwZXMnO1xuaW1wb3J0IGdycGNBdXRoID0gYXV0aC5hdXRoO1xuaW1wb3J0IHtIZWFkZXIsIEhlYWRlckludGVyY2VwdG9yUHJvdmlkZXJ9IGZyb20gJy4vZ3JwYy9oZWFkZXJzLWludGVyY2VwdG9yJztcbmltcG9ydCB7Q2xpZW50VGltZW91dEludGVyY2VwdG9yfSBmcm9tICcuL2dycGMvY2xpZW50LXRpbWVvdXQtaW50ZXJjZXB0b3InO1xuaW1wb3J0IHtDaGFubmVsQ3JlZGVudGlhbHMsIEludGVyY2VwdG9yfSBmcm9tICdAZ3JwYy9ncnBjLWpzJztcbmltcG9ydCB7dmVyc2lvbn0gZnJvbSAnLi4vLi4vcGFja2FnZS5qc29uJztcbmltcG9ydCB7Y2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXJ9IGZyb20gJy4uL2Vycm9ycy9jYWNoZS1zZXJ2aWNlLWVycm9yLW1hcHBlcic7XG5pbXBvcnQge1xuICBJbnRlcm5hbFN1cGVyVXNlclBlcm1pc3Npb25zLFxuICB2YWxpZGF0ZVZhbGlkRm9yU2Vjb25kcyxcbn0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZS9kaXN0L3NyYy9pbnRlcm5hbC91dGlscyc7XG5pbXBvcnQgTmV2ZXIgPSBncnBjQXV0aC5fR2VuZXJhdGVBcGlUb2tlblJlcXVlc3QuTmV2ZXI7XG5pbXBvcnQgRXhwaXJlcyA9IGdycGNBdXRoLl9HZW5lcmF0ZUFwaVRva2VuUmVxdWVzdC5FeHBpcmVzO1xuaW1wb3J0IHtcbiAgRXhwaXJlc0luLFxuICBFeHBpcmVzQXQsXG4gIENyZWRlbnRpYWxQcm92aWRlcixcbiAgUmVmcmVzaEF1dGhUb2tlbixcbiAgR2VuZXJhdGVBdXRoVG9rZW4sXG4gIFRva2VuU2NvcGUsXG4gIFBlcm1pc3Npb25zLFxuICBQZXJtaXNzaW9uLFxuICBUb3BpY1Blcm1pc3Npb24sXG4gIENhY2hlUGVybWlzc2lvbixcbiAgVG9waWNSb2xlLFxuICBDYWNoZVJvbGUsXG4gIEFsbENhY2hlcyxcbiAgQWxsVG9waWNzLFxuICBpc0NhY2hlTmFtZSxcbiAgaXNUb3BpY05hbWUsXG59IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUnO1xuaW1wb3J0IHtJQXV0aENsaWVudH0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZS9kaXN0L3NyYy9pbnRlcm5hbC9jbGllbnRzJztcbmltcG9ydCB7QXV0aENsaWVudFByb3BzfSBmcm9tICcuLi9hdXRoLWNsaWVudC1wcm9wcyc7XG5pbXBvcnQge25vcm1hbGl6ZVNka0Vycm9yfSBmcm9tICdAZ29tb21lbnRvL3Nkay1jb3JlL2Rpc3Qvc3JjL2Vycm9ycyc7XG5pbXBvcnQge1xuICBhc0NhY2hlUGVybWlzc2lvbixcbiAgYXNQZXJtaXNzaW9uc09iamVjdCxcbiAgYXNUb3BpY1Blcm1pc3Npb24sXG4gIGlzQ2FjaGVQZXJtaXNzaW9uLFxuICBpc1Blcm1pc3Npb25zT2JqZWN0LFxuICBpc1RvcGljUGVybWlzc2lvbixcbn0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZS9kaXN0L3NyYy9hdXRoL3Rva2Vucy90b2tlbi1zY29wZSc7XG5cbmV4cG9ydCBjbGFzcyBJbnRlcm5hbEF1dGhDbGllbnQgaW1wbGVtZW50cyBJQXV0aENsaWVudCB7XG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IFJFUVVFU1RfVElNRU9VVF9NUzogbnVtYmVyID0gNjAgKiAxMDAwO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgY3JlZHM6IENyZWRlbnRpYWxQcm92aWRlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBpbnRlcmNlcHRvcnM6IEludGVyY2VwdG9yW107XG5cbiAgY29uc3RydWN0b3IocHJvcHM6IEF1dGhDbGllbnRQcm9wcykge1xuICAgIHRoaXMuY3JlZHMgPSBwcm9wcy5jcmVkZW50aWFsUHJvdmlkZXI7XG4gICAgY29uc3QgaGVhZGVycyA9IFtuZXcgSGVhZGVyKCdBZ2VudCcsIGBub2RlanM6JHt2ZXJzaW9ufWApXTtcbiAgICB0aGlzLmludGVyY2VwdG9ycyA9IFtcbiAgICAgIG5ldyBIZWFkZXJJbnRlcmNlcHRvclByb3ZpZGVyKGhlYWRlcnMpLmNyZWF0ZUhlYWRlcnNJbnRlcmNlcHRvcigpLFxuICAgICAgQ2xpZW50VGltZW91dEludGVyY2VwdG9yKEludGVybmFsQXV0aENsaWVudC5SRVFVRVNUX1RJTUVPVVRfTVMpLFxuICAgIF07XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2VuZXJhdGVBdXRoVG9rZW4oXG4gICAgc2NvcGU6IFRva2VuU2NvcGUsXG4gICAgZXhwaXJlc0luOiBFeHBpcmVzSW5cbiAgKTogUHJvbWlzZTxHZW5lcmF0ZUF1dGhUb2tlbi5SZXNwb25zZT4ge1xuICAgIGNvbnN0IGF1dGhDbGllbnQgPSBuZXcgZ3JwY0F1dGguQXV0aENsaWVudChcbiAgICAgIHRoaXMuY3JlZHMuZ2V0Q29udHJvbEVuZHBvaW50KCksXG4gICAgICBDaGFubmVsQ3JlZGVudGlhbHMuY3JlYXRlU3NsKClcbiAgICApO1xuXG4gICAgbGV0IHBlcm1pc3Npb25zO1xuICAgIHRyeSB7XG4gICAgICBwZXJtaXNzaW9ucyA9IHBlcm1pc3Npb25zRnJvbVNjb3BlKHNjb3BlKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiBuZXcgR2VuZXJhdGVBdXRoVG9rZW4uRXJyb3Iobm9ybWFsaXplU2RrRXJyb3IoZXJyIGFzIEVycm9yKSk7XG4gICAgfVxuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgZ3JwY0F1dGguX0dlbmVyYXRlQXBpVG9rZW5SZXF1ZXN0KHtcbiAgICAgIGF1dGhfdG9rZW46IHRoaXMuY3JlZHMuZ2V0QXV0aFRva2VuKCksXG4gICAgICBwZXJtaXNzaW9uczogcGVybWlzc2lvbnMsXG4gICAgfSk7XG5cbiAgICBpZiAoZXhwaXJlc0luLmRvZXNFeHBpcmUoKSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdmFsaWRhdGVWYWxpZEZvclNlY29uZHMoZXhwaXJlc0luLnNlY29uZHMoKSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBHZW5lcmF0ZUF1dGhUb2tlbi5FcnJvcihub3JtYWxpemVTZGtFcnJvcihlcnIgYXMgRXJyb3IpKTtcbiAgICAgIH1cblxuICAgICAgcmVxdWVzdC5leHBpcmVzID0gbmV3IEV4cGlyZXMoe1xuICAgICAgICB2YWxpZF9mb3Jfc2Vjb25kczogZXhwaXJlc0luLnNlY29uZHMoKSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXF1ZXN0Lm5ldmVyID0gbmV3IE5ldmVyKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlPEdlbmVyYXRlQXV0aFRva2VuLlJlc3BvbnNlPihyZXNvbHZlID0+IHtcbiAgICAgIGF1dGhDbGllbnQuR2VuZXJhdGVBcGlUb2tlbihcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAge2ludGVyY2VwdG9yczogdGhpcy5pbnRlcmNlcHRvcnN9LFxuICAgICAgICAoZXJyLCByZXNwKSA9PiB7XG4gICAgICAgICAgaWYgKGVyciB8fCAhcmVzcCkge1xuICAgICAgICAgICAgcmVzb2x2ZShuZXcgR2VuZXJhdGVBdXRoVG9rZW4uRXJyb3IoY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIoZXJyKSkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXNvbHZlKFxuICAgICAgICAgICAgICBuZXcgR2VuZXJhdGVBdXRoVG9rZW4uU3VjY2VzcyhcbiAgICAgICAgICAgICAgICByZXNwLmFwaV9rZXksXG4gICAgICAgICAgICAgICAgcmVzcC5yZWZyZXNoX3Rva2VuLFxuICAgICAgICAgICAgICAgIHJlc3AuZW5kcG9pbnQsXG4gICAgICAgICAgICAgICAgRXhwaXJlc0F0LmZyb21FcG9jaChyZXNwLnZhbGlkX3VudGlsKVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWZyZXNoQXV0aFRva2VuKFxuICAgIHJlZnJlc2hUb2tlbjogc3RyaW5nXG4gICk6IFByb21pc2U8UmVmcmVzaEF1dGhUb2tlbi5SZXNwb25zZT4ge1xuICAgIGNvbnN0IGF1dGhDbGllbnQgPSBuZXcgZ3JwY0F1dGguQXV0aENsaWVudChcbiAgICAgIHRoaXMuY3JlZHMuZ2V0Q29udHJvbEVuZHBvaW50KCksXG4gICAgICBDaGFubmVsQ3JlZGVudGlhbHMuY3JlYXRlU3NsKClcbiAgICApO1xuXG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBncnBjQXV0aC5fUmVmcmVzaEFwaVRva2VuUmVxdWVzdCh7XG4gICAgICBhcGlfa2V5OiB0aGlzLmNyZWRzLmdldEF1dGhUb2tlbigpLFxuICAgICAgcmVmcmVzaF90b2tlbjogcmVmcmVzaFRva2VuLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlPFJlZnJlc2hBdXRoVG9rZW4uUmVzcG9uc2U+KHJlc29sdmUgPT4ge1xuICAgICAgYXV0aENsaWVudC5SZWZyZXNoQXBpVG9rZW4oXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIHtpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzfSxcbiAgICAgICAgKGVyciwgcmVzcCkgPT4ge1xuICAgICAgICAgIGlmIChlcnIgfHwgIXJlc3ApIHtcbiAgICAgICAgICAgIHJlc29sdmUobmV3IFJlZnJlc2hBdXRoVG9rZW4uRXJyb3IoY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIoZXJyKSkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXNvbHZlKFxuICAgICAgICAgICAgICBuZXcgUmVmcmVzaEF1dGhUb2tlbi5TdWNjZXNzKFxuICAgICAgICAgICAgICAgIHJlc3AuYXBpX2tleSxcbiAgICAgICAgICAgICAgICByZXNwLnJlZnJlc2hfdG9rZW4sXG4gICAgICAgICAgICAgICAgcmVzcC5lbmRwb2ludCxcbiAgICAgICAgICAgICAgICBFeHBpcmVzQXQuZnJvbUVwb2NoKHJlc3AudmFsaWRfdW50aWwpXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwZXJtaXNzaW9uc0Zyb21TY29wZShcbiAgc2NvcGU6IFRva2VuU2NvcGVcbik6IGdycGNBdXRoLl9HZW5lcmF0ZUFwaVRva2VuUmVxdWVzdC5QZXJtaXNzaW9ucyB7XG4gIGNvbnN0IHJlc3VsdCA9IG5ldyBncnBjQXV0aC5fR2VuZXJhdGVBcGlUb2tlblJlcXVlc3QuUGVybWlzc2lvbnMoKTtcbiAgaWYgKHNjb3BlIGluc3RhbmNlb2YgSW50ZXJuYWxTdXBlclVzZXJQZXJtaXNzaW9ucykge1xuICAgIHJlc3VsdC5zdXBlcl91c2VyID1cbiAgICAgIGdycGNBdXRoLl9HZW5lcmF0ZUFwaVRva2VuUmVxdWVzdC5TdXBlclVzZXJQZXJtaXNzaW9ucy5TdXBlclVzZXI7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfSBlbHNlIGlmIChpc1Blcm1pc3Npb25zT2JqZWN0KHNjb3BlKSkge1xuICAgIGNvbnN0IHNjb3BlUGVybWlzc2lvbnM6IFBlcm1pc3Npb25zID0gYXNQZXJtaXNzaW9uc09iamVjdChzY29wZSk7XG4gICAgY29uc3QgZXhwbGljaXRQZXJtaXNzaW9ucyA9XG4gICAgICBuZXcgZ3JwY0F1dGguX0dlbmVyYXRlQXBpVG9rZW5SZXF1ZXN0LkV4cGxpY2l0UGVybWlzc2lvbnMoKTtcbiAgICBleHBsaWNpdFBlcm1pc3Npb25zLnBlcm1pc3Npb25zID0gc2NvcGVQZXJtaXNzaW9ucy5wZXJtaXNzaW9ucy5tYXAocCA9PlxuICAgICAgdG9rZW5QZXJtaXNzaW9uVG9HcnBjUGVybWlzc2lvbihwKVxuICAgICk7XG4gICAgcmVzdWx0LmV4cGxpY2l0ID0gZXhwbGljaXRQZXJtaXNzaW9ucztcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG4gIHRocm93IG5ldyBFcnJvcihgVW5yZWNvZ25pemVkIHRva2VuIHNjb3BlOiAke0pTT04uc3RyaW5naWZ5KHNjb3BlKX1gKTtcbn1cblxuZnVuY3Rpb24gdG9rZW5QZXJtaXNzaW9uVG9HcnBjUGVybWlzc2lvbihcbiAgcGVybWlzc2lvbjogUGVybWlzc2lvblxuKTogZ3JwY0F1dGguX0dlbmVyYXRlQXBpVG9rZW5SZXF1ZXN0LlBlcm1pc3Npb25zVHlwZSB7XG4gIGNvbnN0IHJlc3VsdCA9IG5ldyBncnBjQXV0aC5fR2VuZXJhdGVBcGlUb2tlblJlcXVlc3QuUGVybWlzc2lvbnNUeXBlKCk7XG4gIGlmIChpc1RvcGljUGVybWlzc2lvbihwZXJtaXNzaW9uKSkge1xuICAgIHJlc3VsdC50b3BpY19wZXJtaXNzaW9ucyA9IHRvcGljUGVybWlzc2lvblRvR3JwY1Blcm1pc3Npb24oXG4gICAgICBhc1RvcGljUGVybWlzc2lvbihwZXJtaXNzaW9uKVxuICAgICk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfSBlbHNlIGlmIChpc0NhY2hlUGVybWlzc2lvbihwZXJtaXNzaW9uKSkge1xuICAgIHJlc3VsdC5jYWNoZV9wZXJtaXNzaW9ucyA9IGNhY2hlUGVybWlzc2lvblRvR3JwY1Blcm1pc3Npb24oXG4gICAgICBhc0NhY2hlUGVybWlzc2lvbihwZXJtaXNzaW9uKVxuICAgICk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgYFVucmVjb2duaXplZCB0b2tlbiBwZXJtaXNzaW9uOiAke0pTT04uc3RyaW5naWZ5KHBlcm1pc3Npb24pfWBcbiAgKTtcbn1cblxuZnVuY3Rpb24gdG9waWNQZXJtaXNzaW9uVG9HcnBjUGVybWlzc2lvbihcbiAgcGVybWlzc2lvbjogVG9waWNQZXJtaXNzaW9uXG4pOiBncnBjQXV0aC5fR2VuZXJhdGVBcGlUb2tlblJlcXVlc3QuUGVybWlzc2lvbnNUeXBlLlRvcGljUGVybWlzc2lvbnMge1xuICBjb25zdCBncnBjUGVybWlzc2lvbiA9XG4gICAgbmV3IGdycGNBdXRoLl9HZW5lcmF0ZUFwaVRva2VuUmVxdWVzdC5QZXJtaXNzaW9uc1R5cGUuVG9waWNQZXJtaXNzaW9ucygpO1xuICBzd2l0Y2ggKHBlcm1pc3Npb24ucm9sZSkge1xuICAgIGNhc2UgVG9waWNSb2xlLlB1Ymxpc2hTdWJzY3JpYmU6IHtcbiAgICAgIGdycGNQZXJtaXNzaW9uLnJvbGUgPVxuICAgICAgICBncnBjQXV0aC5fR2VuZXJhdGVBcGlUb2tlblJlcXVlc3QuVG9waWNSb2xlLlRvcGljUmVhZFdyaXRlO1xuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGNhc2UgVG9waWNSb2xlLlN1YnNjcmliZU9ubHk6IHtcbiAgICAgIGdycGNQZXJtaXNzaW9uLnJvbGUgPVxuICAgICAgICBncnBjQXV0aC5fR2VuZXJhdGVBcGlUb2tlblJlcXVlc3QuVG9waWNSb2xlLlRvcGljUmVhZE9ubHk7XG4gICAgICBicmVhaztcbiAgICB9XG4gICAgZGVmYXVsdDoge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbnJlY29nbml6ZWQgdG9waWMgcm9sZTogJHtKU09OLnN0cmluZ2lmeShwZXJtaXNzaW9uKX1gKTtcbiAgICB9XG4gIH1cblxuICBpZiAocGVybWlzc2lvbi5jYWNoZSA9PT0gQWxsQ2FjaGVzKSB7XG4gICAgZ3JwY1Blcm1pc3Npb24uYWxsX2NhY2hlcyA9XG4gICAgICBuZXcgZ3JwY0F1dGguX0dlbmVyYXRlQXBpVG9rZW5SZXF1ZXN0LlBlcm1pc3Npb25zVHlwZS5BbGwoKTtcbiAgfSBlbHNlIGlmICh0eXBlb2YgcGVybWlzc2lvbi5jYWNoZSA9PT0gJ3N0cmluZycpIHtcbiAgICBncnBjUGVybWlzc2lvbi5jYWNoZV9zZWxlY3RvciA9XG4gICAgICBuZXcgZ3JwY0F1dGguX0dlbmVyYXRlQXBpVG9rZW5SZXF1ZXN0LlBlcm1pc3Npb25zVHlwZS5DYWNoZVNlbGVjdG9yKHtcbiAgICAgICAgY2FjaGVfbmFtZTogcGVybWlzc2lvbi5jYWNoZSxcbiAgICAgIH0pO1xuICB9IGVsc2UgaWYgKGlzQ2FjaGVOYW1lKHBlcm1pc3Npb24uY2FjaGUpKSB7XG4gICAgZ3JwY1Blcm1pc3Npb24uY2FjaGVfc2VsZWN0b3IgPVxuICAgICAgbmV3IGdycGNBdXRoLl9HZW5lcmF0ZUFwaVRva2VuUmVxdWVzdC5QZXJtaXNzaW9uc1R5cGUuQ2FjaGVTZWxlY3Rvcih7XG4gICAgICAgIGNhY2hlX25hbWU6IHBlcm1pc3Npb24uY2FjaGUubmFtZSxcbiAgICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBVbnJlY29nbml6ZWQgY2FjaGUgc3BlY2lmaWNhdGlvbiBpbiB0b3BpYyBwZXJtaXNzaW9uOiAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICBwZXJtaXNzaW9uXG4gICAgICApfWBcbiAgICApO1xuICB9XG5cbiAgaWYgKHBlcm1pc3Npb24udG9waWMgPT09IEFsbFRvcGljcykge1xuICAgIGdycGNQZXJtaXNzaW9uLmFsbF90b3BpY3MgPVxuICAgICAgbmV3IGdycGNBdXRoLl9HZW5lcmF0ZUFwaVRva2VuUmVxdWVzdC5QZXJtaXNzaW9uc1R5cGUuQWxsKCk7XG4gIH0gZWxzZSBpZiAodHlwZW9mIHBlcm1pc3Npb24udG9waWMgPT09ICdzdHJpbmcnKSB7XG4gICAgZ3JwY1Blcm1pc3Npb24udG9waWNfc2VsZWN0b3IgPVxuICAgICAgbmV3IGdycGNBdXRoLl9HZW5lcmF0ZUFwaVRva2VuUmVxdWVzdC5QZXJtaXNzaW9uc1R5cGUuVG9waWNTZWxlY3Rvcih7XG4gICAgICAgIHRvcGljX25hbWU6IHBlcm1pc3Npb24udG9waWMsXG4gICAgICB9KTtcbiAgfSBlbHNlIGlmIChpc1RvcGljTmFtZShwZXJtaXNzaW9uLnRvcGljKSkge1xuICAgIGdycGNQZXJtaXNzaW9uLnRvcGljX3NlbGVjdG9yID1cbiAgICAgIG5ldyBncnBjQXV0aC5fR2VuZXJhdGVBcGlUb2tlblJlcXVlc3QuUGVybWlzc2lvbnNUeXBlLlRvcGljU2VsZWN0b3Ioe1xuICAgICAgICB0b3BpY19uYW1lOiBwZXJtaXNzaW9uLnRvcGljLm5hbWUsXG4gICAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgVW5yZWNvZ25pemVkIHRvcGljIHNwZWNpZmljYXRpb24gaW4gdG9waWMgcGVybWlzc2lvbjogJHtKU09OLnN0cmluZ2lmeShcbiAgICAgICAgcGVybWlzc2lvblxuICAgICAgKX1gXG4gICAgKTtcbiAgfVxuICByZXR1cm4gZ3JwY1Blcm1pc3Npb247XG59XG5cbmZ1bmN0aW9uIGNhY2hlUGVybWlzc2lvblRvR3JwY1Blcm1pc3Npb24oXG4gIHBlcm1pc3Npb246IENhY2hlUGVybWlzc2lvblxuKTogZ3JwY0F1dGguX0dlbmVyYXRlQXBpVG9rZW5SZXF1ZXN0LlBlcm1pc3Npb25zVHlwZS5DYWNoZVBlcm1pc3Npb25zIHtcbiAgY29uc3QgZ3JwY1Blcm1pc3Npb24gPVxuICAgIG5ldyBncnBjQXV0aC5fR2VuZXJhdGVBcGlUb2tlblJlcXVlc3QuUGVybWlzc2lvbnNUeXBlLkNhY2hlUGVybWlzc2lvbnMoKTtcbiAgc3dpdGNoIChwZXJtaXNzaW9uLnJvbGUpIHtcbiAgICBjYXNlIENhY2hlUm9sZS5SZWFkV3JpdGU6IHtcbiAgICAgIGdycGNQZXJtaXNzaW9uLnJvbGUgPVxuICAgICAgICBncnBjQXV0aC5fR2VuZXJhdGVBcGlUb2tlblJlcXVlc3QuQ2FjaGVSb2xlLkNhY2hlUmVhZFdyaXRlO1xuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGNhc2UgQ2FjaGVSb2xlLlJlYWRPbmx5OiB7XG4gICAgICBncnBjUGVybWlzc2lvbi5yb2xlID1cbiAgICAgICAgZ3JwY0F1dGguX0dlbmVyYXRlQXBpVG9rZW5SZXF1ZXN0LkNhY2hlUm9sZS5DYWNoZVJlYWRPbmx5O1xuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGRlZmF1bHQ6IHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5yZWNvZ25pemVkIGNhY2hlIHJvbGU6ICR7SlNPTi5zdHJpbmdpZnkocGVybWlzc2lvbil9YCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKHBlcm1pc3Npb24uY2FjaGUgPT09IEFsbENhY2hlcykge1xuICAgIGdycGNQZXJtaXNzaW9uLmFsbF9jYWNoZXMgPVxuICAgICAgbmV3IGdycGNBdXRoLl9HZW5lcmF0ZUFwaVRva2VuUmVxdWVzdC5QZXJtaXNzaW9uc1R5cGUuQWxsKCk7XG4gIH0gZWxzZSBpZiAodHlwZW9mIHBlcm1pc3Npb24uY2FjaGUgPT09ICdzdHJpbmcnKSB7XG4gICAgZ3JwY1Blcm1pc3Npb24uY2FjaGVfc2VsZWN0b3IgPVxuICAgICAgbmV3IGdycGNBdXRoLl9HZW5lcmF0ZUFwaVRva2VuUmVxdWVzdC5QZXJtaXNzaW9uc1R5cGUuQ2FjaGVTZWxlY3Rvcih7XG4gICAgICAgIGNhY2hlX25hbWU6IHBlcm1pc3Npb24uY2FjaGUsXG4gICAgICB9KTtcbiAgfSBlbHNlIGlmIChpc0NhY2hlTmFtZShwZXJtaXNzaW9uLmNhY2hlKSkge1xuICAgIGdycGNQZXJtaXNzaW9uLmNhY2hlX3NlbGVjdG9yID1cbiAgICAgIG5ldyBncnBjQXV0aC5fR2VuZXJhdGVBcGlUb2tlblJlcXVlc3QuUGVybWlzc2lvbnNUeXBlLkNhY2hlU2VsZWN0b3Ioe1xuICAgICAgICBjYWNoZV9uYW1lOiBwZXJtaXNzaW9uLmNhY2hlLm5hbWUsXG4gICAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgVW5yZWNvZ25pemVkIGNhY2hlIHNwZWNpZmljYXRpb24gaW4gY2FjaGUgcGVybWlzc2lvbjogJHtKU09OLnN0cmluZ2lmeShcbiAgICAgICAgcGVybWlzc2lvblxuICAgICAgKX1gXG4gICAgKTtcbiAgfVxuICByZXR1cm4gZ3JwY1Blcm1pc3Npb247XG59XG4iXX0=