"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PubsubClient = void 0;
const generated_types_1 = require("@gomomento/generated-types");
var grpcPubsub = generated_types_1.pubsub.cache_client.pubsub;
// older versions of node don't have the global util variables https://github.com/nodejs/node/issues/20365
const headers_interceptor_1 = require("./grpc/headers-interceptor");
const client_timeout_interceptor_1 = require("./grpc/client-timeout-interceptor");
const cache_service_error_mapper_1 = require("../errors/cache-service-error-mapper");
const grpc_js_1 = require("@grpc/grpc-js");
const constants_1 = require("@grpc/grpc-js/build/src/constants");
const package_json_1 = require("../../package.json");
const middlewares_interceptor_1 = require("./grpc/middlewares-interceptor");
const __1 = require("../");
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
const AbstractPubsubClient_1 = require("@gomomento/sdk-core/dist/src/internal/clients/pubsub/AbstractPubsubClient");
class PubsubClient extends AbstractPubsubClient_1.AbstractPubsubClient {
    /**
     * @param {TopicClientProps} props
     */
    constructor(props) {
        super();
        this.configuration = props.configuration;
        this.credentialProvider = props.credentialProvider;
        this.logger = this.configuration.getLoggerFactory().getLogger(this);
        this.unaryRequestTimeoutMs = PubsubClient.DEFAULT_REQUEST_TIMEOUT_MS;
        this.logger.debug(`Creating topic client using endpoint: '${this.credentialProvider.getCacheEndpoint()}'`);
        this.client = new grpcPubsub.PubsubClient(this.credentialProvider.getCacheEndpoint(), grpc_js_1.ChannelCredentials.createSsl(), {
            // default value for max session memory is 10mb.  Under high load, it is easy to exceed this,
            // after which point all requests will fail with a client-side RESOURCE_EXHAUSTED exception.
            'grpc-node.max_session_memory': PubsubClient.DEFAULT_MAX_SESSION_MEMORY_MB,
            // This flag controls whether channels use a shared global pool of subchannels, or whether
            // each channel gets its own subchannel pool.  The default value is 0, meaning a single global
            // pool.  Setting it to 1 provides significant performance improvements when we instantiate more
            // than one grpc client.
            'grpc.use_local_subchannel_pool': 1,
        });
        const headers = [
            new headers_interceptor_1.Header('Authorization', this.credentialProvider.getAuthToken()),
            new headers_interceptor_1.Header('Agent', `nodejs:${package_json_1.version}`),
        ];
        this.unaryInterceptors = PubsubClient.initializeUnaryInterceptors(headers, props.configuration, this.unaryRequestTimeoutMs);
        this.streamingInterceptors =
            PubsubClient.initializeStreamingInterceptors(headers);
    }
    getEndpoint() {
        const endpoint = this.credentialProvider.getCacheEndpoint();
        this.logger.debug(`Using cache endpoint: ${endpoint}`);
        return endpoint;
    }
    async sendPublish(cacheName, topicName, value) {
        const topicValue = new grpcPubsub._TopicValue();
        if (typeof value === 'string') {
            topicValue.text = value;
        }
        else {
            topicValue.binary = value;
        }
        const request = new grpcPubsub._PublishRequest({
            cache_name: cacheName,
            topic: topicName,
            value: topicValue,
        });
        return await new Promise(resolve => {
            this.client.Publish(request, {
                interceptors: this.unaryInterceptors,
            }, (err, resp) => {
                if (resp) {
                    resolve(new __1.TopicPublish.Success());
                }
                else {
                    resolve(new __1.TopicPublish.Error((0, cache_service_error_mapper_1.cacheServiceErrorMapper)(err)));
                }
            });
        });
    }
    /**
     * @remark This method is responsible for restarting the stream if it ends unexpectedly.
     * Since we return a single subscription object to the user, we need to update it with the
     * unsubscribe function should we restart the stream. This is why we pass the subscription
     * state and subscription object to this method.
     *
     * Handling a cache not exists requires special care as well. In the most likely case,
     * when the subscription starts and the cache does not exist, we receive an error immediately.
     * We return an error from the subscribe method and do immediately unsubscribe. In a distinct,
     * unlikely but possible case, the user deletes the cache while the stream is running. In this
     * case we already returned a subscription object to the user, so we instead cancel the stream and
     * propagate an error to the user via the error handler.
     */
    sendSubscribe(options) {
        const request = new grpcPubsub._SubscriptionRequest({
            cache_name: options.cacheName,
            topic: options.topicName,
            resume_at_topic_sequence_number: options.subscriptionState.resumeAtTopicSequenceNumber,
        });
        const call = this.client.Subscribe(request, {
            interceptors: this.streamingInterceptors,
        });
        options.subscriptionState.setSubscribed();
        // Allow the caller to cancel the stream.
        // Note that because we restart the stream on error or stream end,
        // we need to ensure we keep the same subscription object. That way
        // stream restarts are transparent to the caller.
        options.subscriptionState.unsubscribeFn = () => {
            call.cancel();
        };
        return new Promise(resolve => {
            const prepareCallbackOptions = {
                ...options,
                restartedDueToError: false,
                firstMessage: true,
                resolve,
            };
            call.on('data', this.prepareDataCallback(prepareCallbackOptions));
            call.on('error', this.prepareErrorCallback(prepareCallbackOptions));
            call.on('end', this.prepareEndCallback(prepareCallbackOptions));
        });
    }
    prepareDataCallback(options) {
        return (resp) => {
            if (options.firstMessage) {
                options.resolve(options.subscription);
            }
            options.firstMessage = false;
            if (resp === null || resp === void 0 ? void 0 : resp.item) {
                options.subscriptionState.lastTopicSequenceNumber =
                    resp.item.topic_sequence_number;
                if (resp.item.value.text) {
                    options.onItem(new __1.TopicItem(resp.item.value.text));
                }
                else if (resp.item.value.binary) {
                    options.onItem(new __1.TopicItem(resp.item.value.binary));
                }
                else {
                    this.logger.error('Received subscription item with unknown type; topic: %s', (0, utils_1.truncateString)(options.topicName));
                    options.onError(new __1.TopicSubscribe.Error(new __1.UnknownError('Unknown item value type')), options.subscription);
                }
            }
            else if (resp === null || resp === void 0 ? void 0 : resp.heartbeat) {
                this.logger.trace('Received heartbeat from subscription stream; topic: %s', (0, utils_1.truncateString)(options.topicName));
            }
            else if (resp === null || resp === void 0 ? void 0 : resp.discontinuity) {
                this.logger.trace('Received discontinuity from subscription stream; topic: %s', (0, utils_1.truncateString)(options.topicName));
            }
            else {
                this.logger.error('Received unknown subscription item; topic: %s', (0, utils_1.truncateString)(options.topicName));
                options.onError(new __1.TopicSubscribe.Error(new __1.UnknownError('Unknown item type')), options.subscription);
            }
        };
    }
    prepareErrorCallback(options) {
        return (err) => {
            // When the caller unsubscribes, we may get a follow on error, which we ignore.
            if (!options.subscriptionState.isSubscribed) {
                return;
            }
            const serviceError = err;
            const isRstStreamNoError = serviceError.code === constants_1.Status.INTERNAL &&
                serviceError.details === PubsubClient.RST_STREAM_NO_ERROR_MESSAGE;
            const momentoError = new __1.TopicSubscribe.Error((0, cache_service_error_mapper_1.cacheServiceErrorMapper)(serviceError));
            this.handleSubscribeError(options, momentoError, isRstStreamNoError);
        };
    }
    static initializeUnaryInterceptors(headers, configuration, requestTimeoutMs) {
        return [
            (0, middlewares_interceptor_1.middlewaresInterceptor)(configuration.getLoggerFactory(), [], {}),
            new headers_interceptor_1.HeaderInterceptorProvider(headers).createHeadersInterceptor(),
            (0, client_timeout_interceptor_1.ClientTimeoutInterceptor)(requestTimeoutMs),
        ];
    }
    // TODO https://github.com/momentohq/client-sdk-nodejs/issues/349
    // decide on streaming interceptors and middlewares
    static initializeStreamingInterceptors(headers) {
        return [new headers_interceptor_1.HeaderInterceptorProvider(headers).createHeadersInterceptor()];
    }
}
exports.PubsubClient = PubsubClient;
PubsubClient.DEFAULT_REQUEST_TIMEOUT_MS = 5 * 1000;
PubsubClient.DEFAULT_MAX_SESSION_MEMORY_MB = 256;
PubsubClient.RST_STREAM_NO_ERROR_MESSAGE = 'Received RST_STREAM with code 0';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHVic3ViLWNsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9pbnRlcm5hbC9wdWJzdWItY2xpZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGdFQUFrRDtBQUNsRCxJQUFPLFVBQVUsR0FBRyx3QkFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUM7QUFDL0MsMEdBQTBHO0FBQzFHLG9FQUE2RTtBQUM3RSxrRkFBMkU7QUFDM0UscUZBQTZFO0FBQzdFLDJDQUE0RTtBQUM1RSxpRUFBeUQ7QUFDekQscURBQTJDO0FBRTNDLDRFQUFzRTtBQUN0RSwyQkFPYTtBQUNiLHVFQUEyRTtBQUMzRSxvSEFJbUY7QUFHbkYsTUFBYSxZQUFhLFNBQVEsMkNBQW9CO0lBY3BEOztPQUVHO0lBQ0gsWUFBWSxLQUF1QjtRQUNqQyxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQztRQUN6QyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFDLGtCQUFrQixDQUFDO1FBQ25ELElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwRSxJQUFJLENBQUMscUJBQXFCLEdBQUcsWUFBWSxDQUFDLDBCQUEwQixDQUFDO1FBQ3JFLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUNmLDBDQUEwQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxDQUN4RixDQUFDO1FBRUYsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLFVBQVUsQ0FBQyxZQUFZLENBQ3ZDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxnQkFBZ0IsRUFBRSxFQUMxQyw0QkFBa0IsQ0FBQyxTQUFTLEVBQUUsRUFDOUI7WUFDRSw2RkFBNkY7WUFDN0YsNEZBQTRGO1lBQzVGLDhCQUE4QixF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LEVBQUUsQ0FBQyxDQUFDO0lBQzdFLENBQUM7O0FBM09ILG9DQTRPQztBQXZPeUIsdUNBQTBCLEdBQVcsQ0FBQyxHQUFHLElBQUksQ0FBQztBQUM5QywwQ0FBNkIsR0FBVyxHQUFHLENBQUM7QUFLNUMsd0NBQTJCLEdBQ2pELGlDQUFpQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtwdWJzdWJ9IGZyb20gJ0Bnb21vbWVudG8vZ2VuZXJhdGVkLXR5cGVzJztcbmltcG9ydCBncnBjUHVic3ViID0gcHVic3ViLmNhY2hlX2NsaWVudC5wdWJzdWI7XG4vLyBvbGRlciB2ZXJzaW9ucyBvZiBub2RlIGRvbid0IGhhdmUgdGhlIGdsb2JhbCB1dGlsIHZhcmlhYmxlcyBodHRwczovL2dpdGh1Yi5jb20vbm9kZWpzL25vZGUvaXNzdWVzLzIwMzY1XG5pbXBvcnQge0hlYWRlciwgSGVhZGVySW50ZXJjZXB0b3JQcm92aWRlcn0gZnJvbSAnLi9ncnBjL2hlYWRlcnMtaW50ZXJjZXB0b3InO1xuaW1wb3J0IHtDbGllbnRUaW1lb3V0SW50ZXJjZXB0b3J9IGZyb20gJy4vZ3JwYy9jbGllbnQtdGltZW91dC1pbnRlcmNlcHRvcic7XG5pbXBvcnQge2NhY2hlU2VydmljZUVycm9yTWFwcGVyfSBmcm9tICcuLi9lcnJvcnMvY2FjaGUtc2VydmljZS1lcnJvci1tYXBwZXInO1xuaW1wb3J0IHtDaGFubmVsQ3JlZGVudGlhbHMsIEludGVyY2VwdG9yLCBTZXJ2aWNlRXJyb3J9IGZyb20gJ0BncnBjL2dycGMtanMnO1xuaW1wb3J0IHtTdGF0dXN9IGZyb20gJ0BncnBjL2dycGMtanMvYnVpbGQvc3JjL2NvbnN0YW50cyc7XG5pbXBvcnQge3ZlcnNpb259IGZyb20gJy4uLy4uL3BhY2thZ2UuanNvbic7XG5pbXBvcnQge1RvcGljQ2xpZW50UHJvcHN9IGZyb20gJy4uL3RvcGljLWNsaWVudC1wcm9wcyc7XG5pbXBvcnQge21pZGRsZXdhcmVzSW50ZXJjZXB0b3J9IGZyb20gJy4vZ3JwYy9taWRkbGV3YXJlcy1pbnRlcmNlcHRvcic7XG5pbXBvcnQge1xuICBDcmVkZW50aWFsUHJvdmlkZXIsXG4gIE1vbWVudG9Mb2dnZXIsXG4gIFRvcGljSXRlbSxcbiAgVG9waWNQdWJsaXNoLFxuICBUb3BpY1N1YnNjcmliZSxcbiAgVW5rbm93bkVycm9yLFxufSBmcm9tICcuLi8nO1xuaW1wb3J0IHt0cnVuY2F0ZVN0cmluZ30gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZS9kaXN0L3NyYy9pbnRlcm5hbC91dGlscyc7XG5pbXBvcnQge1xuICBBYnN0cmFjdFB1YnN1YkNsaWVudCxcbiAgU2VuZFN1YnNjcmliZU9wdGlvbnMsXG4gIFByZXBhcmVTdWJzY3JpYmVDYWxsYmFja09wdGlvbnMsXG59IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvaW50ZXJuYWwvY2xpZW50cy9wdWJzdWIvQWJzdHJhY3RQdWJzdWJDbGllbnQnO1xuaW1wb3J0IHtUb3BpY0NvbmZpZ3VyYXRpb259IGZyb20gJy4uL2NvbmZpZy90b3BpYy1jb25maWd1cmF0aW9uJztcblxuZXhwb3J0IGNsYXNzIFB1YnN1YkNsaWVudCBleHRlbmRzIEFic3RyYWN0UHVic3ViQ2xpZW50IHtcbiAgcHJpdmF0ZSByZWFkb25seSBjbGllbnQ6IGdycGNQdWJzdWIuUHVic3ViQ2xpZW50O1xuICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZ3VyYXRpb246IFRvcGljQ29uZmlndXJhdGlvbjtcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGNyZWRlbnRpYWxQcm92aWRlcjogQ3JlZGVudGlhbFByb3ZpZGVyO1xuICBwcml2YXRlIHJlYWRvbmx5IHVuYXJ5UmVxdWVzdFRpbWVvdXRNczogbnVtYmVyO1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBERUZBVUxUX1JFUVVFU1RfVElNRU9VVF9NUzogbnVtYmVyID0gNSAqIDEwMDA7XG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IERFRkFVTFRfTUFYX1NFU1NJT05fTUVNT1JZX01COiBudW1iZXIgPSAyNTY7XG4gIHByb3RlY3RlZCByZWFkb25seSBsb2dnZXI6IE1vbWVudG9Mb2dnZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgdW5hcnlJbnRlcmNlcHRvcnM6IEludGVyY2VwdG9yW107XG4gIHByaXZhdGUgcmVhZG9ubHkgc3RyZWFtaW5nSW50ZXJjZXB0b3JzOiBJbnRlcmNlcHRvcltdO1xuXG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IFJTVF9TVFJFQU1fTk9fRVJST1JfTUVTU0FHRSA9XG4gICAgJ1JlY2VpdmVkIFJTVF9TVFJFQU0gd2l0aCBjb2RlIDAnO1xuXG4gIC8qKlxuICAgKiBAcGFyYW0ge1RvcGljQ2xpZW50UHJvcHN9IHByb3BzXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihwcm9wczogVG9waWNDbGllbnRQcm9wcykge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5jb25maWd1cmF0aW9uID0gcHJvcHMuY29uZmlndXJhdGlvbjtcbiAgICB0aGlzLmNyZWRlbnRpYWxQcm92aWRlciA9IHByb3BzLmNyZWRlbnRpYWxQcm92aWRlcjtcbiAgICB0aGlzLmxvZ2dlciA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRMb2dnZXJGYWN0b3J5KCkuZ2V0TG9nZ2VyKHRoaXMpO1xuICAgIHRoaXMudW5hcnlSZXF1ZXN0VGltZW91dE1zID0gUHVic3ViQ2xpZW50LkRFRkFVTFRfUkVRVUVTVF9USU1FT1VUX01TO1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKFxuICAgICAgYENyZWF0aW5nIHRvcGljIGNsaWVudCB1c2luZyBlbmRwb2ludDogJyR7dGhpcy5jcmVkZW50aWFsUHJvdmlkZXIuZ2V0Q2FjaGVFbmRwb2ludCgpfSdgXG4gICAgKTtcblxuICAgIHRoaXMuY2xpZW50ID0gbmV3IGdycGNQdWJzdWIuUHVic3ViQ2xpZW50KFxuICAgICAgdGhpcy5jcmVkZW50aWFsUHJvdmlkZXIuZ2V0Q2FjaGVFbmRwb2ludCgpLFxuICAgICAgQ2hhbm5lbENyZWRlbnRpYWxzLmNyZWF0ZVNzbCgpLFxuICAgICAge1xuICAgICAgICAvLyBkZWZhdWx0IHZhbHVlIGZvciBtYXggc2Vzc2lvbiBtZW1vcnkgaXMgMTBtYi4gIFVuZGVyIGhpZ2ggbG9hZCwgaXQgaXMgZWFzeSB0byBleGNlZWQgdGhpcyxcbiAgICAgICAgLy8gYWZ0ZXIgd2hpY2ggcG9pbnQgYWxsIHJlcXVlc3RzIHdpbGwgZmFpbCB3aXRoIGEgY2xpZW50LXNpZGUgUkVTT1VSQ0VfRVhIQVVTVEVEIGV4Y2VwdGlvbi5cbiAgICAgICAgJ2dycGMtbm9kZS5tYXhfc2Vzc2lvbl9tZW1vcnknOlxuICAgICAgICAgIFB1YnN1YkNsaWVudC5ERUZBVUxUX01BWF9TRVNTSU9OX01FTU9SWV9NQixcbiAgICAgICAgLy8gVGhpcyBmbGFnIGNvbnRyb2xzIHdoZXRoZXIgY2hhbm5lbHMgdXNlIGEgc2hhcmVkIGdsb2JhbCBwb29sIG9mIHN1YmNoYW5uZWxzLCBvciB3aGV0aGVyXG4gICAgICAgIC8vIGVhY2ggY2hhbm5lbCBnZXRzIGl0cyBvd24gc3ViY2hhbm5lbCBwb29sLiAgVGhlIGRlZmF1bHQgdmFsdWUgaXMgMCwgbWVhbmluZyBhIHNpbmdsZSBnbG9iYWxcbiAgICAgICAgLy8gcG9vbC4gIFNldHRpbmcgaXQgdG8gMSBwcm92aWRlcyBzaWduaWZpY2FudCBwZXJmb3JtYW5jZSBpbXByb3ZlbWVudHMgd2hlbiB3ZSBpbnN0YW50aWF0ZSBtb3JlXG4gICAgICAgIC8vIHRoYW4gb25lIGdycGMgY2xpZW50LlxuICAgICAgICAnZ3JwYy51c2VfbG9jYWxfc3ViY2hhbm5lbF9wb29sJzogMSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgY29uc3QgaGVhZGVyczogSGVhZGVyW10gPSBbXG4gICAgICBuZXcgSGVhZGVyKCdBdXRob3JpemF0aW9uJywgdGhpcy5jcmVkZW50aWFsUHJvdmlkZXIuZ2V0QXV0aFRva2VuKCkpLFxuICAgICAgbmV3IEhlYWRlcignQWdlbnQnLCBgbm9kZWpzOiR7dmVyc2lvbn1gKSxcbiAgICBdO1xuICAgIHRoaXMudW5hcnlJbnRlcmNlcHRvcnMgPSBQdWJzdWJDbGllbnQuaW5pdGlhbGl6ZVVuYXJ5SW50ZXJjZXB0b3JzKFxuICAgICAgaGVhZGVycyxcbiAgICAgIHByb3BzLmNvbmZpZ3VyYXRpb24sXG4gICAgICB0aGlzLnVuYXJ5UmVxdWVzdFRpbWVvdXRNc1xuICAgICk7XG4gICAgdGhpcy5zdHJlYW1pbmdJbnRlcmNlcHRvcnMgPVxuICAgICAgUHVic3ViQ2xpZW50LmluaXRpYWxpemVTdHJlYW1pbmdJbnRlcmNlcHRvcnMoaGVhZGVycyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0RW5kcG9pbnQoKTogc3RyaW5nIHtcbiAgICBjb25zdCBlbmRwb2ludCA9IHRoaXMuY3JlZGVudGlhbFByb3ZpZGVyLmdldENhY2hlRW5kcG9pbnQoKTtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgVXNpbmcgY2FjaGUgZW5kcG9pbnQ6ICR7ZW5kcG9pbnR9YCk7XG4gICAgcmV0dXJuIGVuZHBvaW50O1xuICB9XG5cbiAgcHJvdGVjdGVkIGFzeW5jIHNlbmRQdWJsaXNoKFxuICAgIGNhY2hlTmFtZTogc3RyaW5nLFxuICAgIHRvcGljTmFtZTogc3RyaW5nLFxuICAgIHZhbHVlOiBzdHJpbmcgfCBVaW50OEFycmF5XG4gICk6IFByb21pc2U8VG9waWNQdWJsaXNoLlJlc3BvbnNlPiB7XG4gICAgY29uc3QgdG9waWNWYWx1ZSA9IG5ldyBncnBjUHVic3ViLl9Ub3BpY1ZhbHVlKCk7XG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHRvcGljVmFsdWUudGV4dCA9IHZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0b3BpY1ZhbHVlLmJpbmFyeSA9IHZhbHVlO1xuICAgIH1cblxuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgZ3JwY1B1YnN1Yi5fUHVibGlzaFJlcXVlc3Qoe1xuICAgICAgY2FjaGVfbmFtZTogY2FjaGVOYW1lLFxuICAgICAgdG9waWM6IHRvcGljTmFtZSxcbiAgICAgIHZhbHVlOiB0b3BpY1ZhbHVlLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgdGhpcy5jbGllbnQuUHVibGlzaChcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAge1xuICAgICAgICAgIGludGVyY2VwdG9yczogdGhpcy51bmFyeUludGVyY2VwdG9ycyxcbiAgICAgICAgfSxcbiAgICAgICAgKGVyciwgcmVzcCkgPT4ge1xuICAgICAgICAgIGlmIChyZXNwKSB7XG4gICAgICAgICAgICByZXNvbHZlKG5ldyBUb3BpY1B1Ymxpc2guU3VjY2VzcygpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzb2x2ZShuZXcgVG9waWNQdWJsaXNoLkVycm9yKGNhY2hlU2VydmljZUVycm9yTWFwcGVyKGVycikpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQHJlbWFyayBUaGlzIG1ldGhvZCBpcyByZXNwb25zaWJsZSBmb3IgcmVzdGFydGluZyB0aGUgc3RyZWFtIGlmIGl0IGVuZHMgdW5leHBlY3RlZGx5LlxuICAgKiBTaW5jZSB3ZSByZXR1cm4gYSBzaW5nbGUgc3Vic2NyaXB0aW9uIG9iamVjdCB0byB0aGUgdXNlciwgd2UgbmVlZCB0byB1cGRhdGUgaXQgd2l0aCB0aGVcbiAgICogdW5zdWJzY3JpYmUgZnVuY3Rpb24gc2hvdWxkIHdlIHJlc3RhcnQgdGhlIHN0cmVhbS4gVGhpcyBpcyB3aHkgd2UgcGFzcyB0aGUgc3Vic2NyaXB0aW9uXG4gICAqIHN0YXRlIGFuZCBzdWJzY3JpcHRpb24gb2JqZWN0IHRvIHRoaXMgbWV0aG9kLlxuICAgKlxuICAgKiBIYW5kbGluZyBhIGNhY2hlIG5vdCBleGlzdHMgcmVxdWlyZXMgc3BlY2lhbCBjYXJlIGFzIHdlbGwuIEluIHRoZSBtb3N0IGxpa2VseSBjYXNlLFxuICAgKiB3aGVuIHRoZSBzdWJzY3JpcHRpb24gc3RhcnRzIGFuZCB0aGUgY2FjaGUgZG9lcyBub3QgZXhpc3QsIHdlIHJlY2VpdmUgYW4gZXJyb3IgaW1tZWRpYXRlbHkuXG4gICAqIFdlIHJldHVybiBhbiBlcnJvciBmcm9tIHRoZSBzdWJzY3JpYmUgbWV0aG9kIGFuZCBkbyBpbW1lZGlhdGVseSB1bnN1YnNjcmliZS4gSW4gYSBkaXN0aW5jdCxcbiAgICogdW5saWtlbHkgYnV0IHBvc3NpYmxlIGNhc2UsIHRoZSB1c2VyIGRlbGV0ZXMgdGhlIGNhY2hlIHdoaWxlIHRoZSBzdHJlYW0gaXMgcnVubmluZy4gSW4gdGhpc1xuICAgKiBjYXNlIHdlIGFscmVhZHkgcmV0dXJuZWQgYSBzdWJzY3JpcHRpb24gb2JqZWN0IHRvIHRoZSB1c2VyLCBzbyB3ZSBpbnN0ZWFkIGNhbmNlbCB0aGUgc3RyZWFtIGFuZFxuICAgKiBwcm9wYWdhdGUgYW4gZXJyb3IgdG8gdGhlIHVzZXIgdmlhIHRoZSBlcnJvciBoYW5kbGVyLlxuICAgKi9cbiAgcHJvdGVjdGVkIHNlbmRTdWJzY3JpYmUoXG4gICAgb3B0aW9uczogU2VuZFN1YnNjcmliZU9wdGlvbnNcbiAgKTogUHJvbWlzZTxUb3BpY1N1YnNjcmliZS5SZXNwb25zZT4ge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgZ3JwY1B1YnN1Yi5fU3Vic2NyaXB0aW9uUmVxdWVzdCh7XG4gICAgICBjYWNoZV9uYW1lOiBvcHRpb25zLmNhY2hlTmFtZSxcbiAgICAgIHRvcGljOiBvcHRpb25zLnRvcGljTmFtZSxcbiAgICAgIHJlc3VtZV9hdF90b3BpY19zZXF1ZW5jZV9udW1iZXI6XG4gICAgICAgIG9wdGlvbnMuc3Vic2NyaXB0aW9uU3RhdGUucmVzdW1lQXRUb3BpY1NlcXVlbmNlTnVtYmVyLFxuICAgIH0pO1xuXG4gICAgY29uc3QgY2FsbCA9IHRoaXMuY2xpZW50LlN1YnNjcmliZShyZXF1ZXN0LCB7XG4gICAgICBpbnRlcmNlcHRvcnM6IHRoaXMuc3RyZWFtaW5nSW50ZXJjZXB0b3JzLFxuICAgIH0pO1xuICAgIG9wdGlvbnMuc3Vic2NyaXB0aW9uU3RhdGUuc2V0U3Vic2NyaWJlZCgpO1xuXG4gICAgLy8gQWxsb3cgdGhlIGNhbGxlciB0byBjYW5jZWwgdGhlIHN0cmVhbS5cbiAgICAvLyBOb3RlIHRoYXQgYmVjYXVzZSB3ZSByZXN0YXJ0IHRoZSBzdHJlYW0gb24gZXJyb3Igb3Igc3RyZWFtIGVuZCxcbiAgICAvLyB3ZSBuZWVkIHRvIGVuc3VyZSB3ZSBrZWVwIHRoZSBzYW1lIHN1YnNjcmlwdGlvbiBvYmplY3QuIFRoYXQgd2F5XG4gICAgLy8gc3RyZWFtIHJlc3RhcnRzIGFyZSB0cmFuc3BhcmVudCB0byB0aGUgY2FsbGVyLlxuICAgIG9wdGlvbnMuc3Vic2NyaXB0aW9uU3RhdGUudW5zdWJzY3JpYmVGbiA9ICgpID0+IHtcbiAgICAgIGNhbGwuY2FuY2VsKCk7XG4gICAgfTtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgIGNvbnN0IHByZXBhcmVDYWxsYmFja09wdGlvbnM6IFByZXBhcmVTdWJzY3JpYmVDYWxsYmFja09wdGlvbnMgPSB7XG4gICAgICAgIC4uLm9wdGlvbnMsXG4gICAgICAgIHJlc3RhcnRlZER1ZVRvRXJyb3I6IGZhbHNlLFxuICAgICAgICBmaXJzdE1lc3NhZ2U6IHRydWUsXG4gICAgICAgIHJlc29sdmUsXG4gICAgICB9O1xuICAgICAgY2FsbC5vbignZGF0YScsIHRoaXMucHJlcGFyZURhdGFDYWxsYmFjayhwcmVwYXJlQ2FsbGJhY2tPcHRpb25zKSk7XG4gICAgICBjYWxsLm9uKCdlcnJvcicsIHRoaXMucHJlcGFyZUVycm9yQ2FsbGJhY2socHJlcGFyZUNhbGxiYWNrT3B0aW9ucykpO1xuICAgICAgY2FsbC5vbignZW5kJywgdGhpcy5wcmVwYXJlRW5kQ2FsbGJhY2socHJlcGFyZUNhbGxiYWNrT3B0aW9ucykpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBwcmVwYXJlRGF0YUNhbGxiYWNrKFxuICAgIG9wdGlvbnM6IFByZXBhcmVTdWJzY3JpYmVDYWxsYmFja09wdGlvbnNcbiAgKTogKHJlc3A6IGdycGNQdWJzdWIuX1N1YnNjcmlwdGlvbkl0ZW0pID0+IHZvaWQge1xuICAgIHJldHVybiAocmVzcDogZ3JwY1B1YnN1Yi5fU3Vic2NyaXB0aW9uSXRlbSkgPT4ge1xuICAgICAgaWYgKG9wdGlvbnMuZmlyc3RNZXNzYWdlKSB7XG4gICAgICAgIG9wdGlvbnMucmVzb2x2ZShvcHRpb25zLnN1YnNjcmlwdGlvbik7XG4gICAgICB9XG4gICAgICBvcHRpb25zLmZpcnN0TWVzc2FnZSA9IGZhbHNlO1xuXG4gICAgICBpZiAocmVzcD8uaXRlbSkge1xuICAgICAgICBvcHRpb25zLnN1YnNjcmlwdGlvblN0YXRlLmxhc3RUb3BpY1NlcXVlbmNlTnVtYmVyID1cbiAgICAgICAgICByZXNwLml0ZW0udG9waWNfc2VxdWVuY2VfbnVtYmVyO1xuICAgICAgICBpZiAocmVzcC5pdGVtLnZhbHVlLnRleHQpIHtcbiAgICAgICAgICBvcHRpb25zLm9uSXRlbShuZXcgVG9waWNJdGVtKHJlc3AuaXRlbS52YWx1ZS50ZXh0KSk7XG4gICAgICAgIH0gZWxzZSBpZiAocmVzcC5pdGVtLnZhbHVlLmJpbmFyeSkge1xuICAgICAgICAgIG9wdGlvbnMub25JdGVtKG5ldyBUb3BpY0l0ZW0ocmVzcC5pdGVtLnZhbHVlLmJpbmFyeSkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAgICAgJ1JlY2VpdmVkIHN1YnNjcmlwdGlvbiBpdGVtIHdpdGggdW5rbm93biB0eXBlOyB0b3BpYzogJXMnLFxuICAgICAgICAgICAgdHJ1bmNhdGVTdHJpbmcob3B0aW9ucy50b3BpY05hbWUpXG4gICAgICAgICAgKTtcbiAgICAgICAgICBvcHRpb25zLm9uRXJyb3IoXG4gICAgICAgICAgICBuZXcgVG9waWNTdWJzY3JpYmUuRXJyb3IoXG4gICAgICAgICAgICAgIG5ldyBVbmtub3duRXJyb3IoJ1Vua25vd24gaXRlbSB2YWx1ZSB0eXBlJylcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICBvcHRpb25zLnN1YnNjcmlwdGlvblxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAocmVzcD8uaGVhcnRiZWF0KSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLnRyYWNlKFxuICAgICAgICAgICdSZWNlaXZlZCBoZWFydGJlYXQgZnJvbSBzdWJzY3JpcHRpb24gc3RyZWFtOyB0b3BpYzogJXMnLFxuICAgICAgICAgIHRydW5jYXRlU3RyaW5nKG9wdGlvbnMudG9waWNOYW1lKVxuICAgICAgICApO1xuICAgICAgfSBlbHNlIGlmIChyZXNwPy5kaXNjb250aW51aXR5KSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLnRyYWNlKFxuICAgICAgICAgICdSZWNlaXZlZCBkaXNjb250aW51aXR5IGZyb20gc3Vic2NyaXB0aW9uIHN0cmVhbTsgdG9waWM6ICVzJyxcbiAgICAgICAgICB0cnVuY2F0ZVN0cmluZyhvcHRpb25zLnRvcGljTmFtZSlcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAgICdSZWNlaXZlZCB1bmtub3duIHN1YnNjcmlwdGlvbiBpdGVtOyB0b3BpYzogJXMnLFxuICAgICAgICAgIHRydW5jYXRlU3RyaW5nKG9wdGlvbnMudG9waWNOYW1lKVxuICAgICAgICApO1xuICAgICAgICBvcHRpb25zLm9uRXJyb3IoXG4gICAgICAgICAgbmV3IFRvcGljU3Vic2NyaWJlLkVycm9yKG5ldyBVbmtub3duRXJyb3IoJ1Vua25vd24gaXRlbSB0eXBlJykpLFxuICAgICAgICAgIG9wdGlvbnMuc3Vic2NyaXB0aW9uXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgcHJlcGFyZUVycm9yQ2FsbGJhY2soXG4gICAgb3B0aW9uczogUHJlcGFyZVN1YnNjcmliZUNhbGxiYWNrT3B0aW9uc1xuICApOiAoZXJyOiBFcnJvcikgPT4gdm9pZCB7XG4gICAgcmV0dXJuIChlcnI6IEVycm9yKSA9PiB7XG4gICAgICAvLyBXaGVuIHRoZSBjYWxsZXIgdW5zdWJzY3JpYmVzLCB3ZSBtYXkgZ2V0IGEgZm9sbG93IG9uIGVycm9yLCB3aGljaCB3ZSBpZ25vcmUuXG4gICAgICBpZiAoIW9wdGlvbnMuc3Vic2NyaXB0aW9uU3RhdGUuaXNTdWJzY3JpYmVkKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgY29uc3Qgc2VydmljZUVycm9yID0gZXJyIGFzIHVua25vd24gYXMgU2VydmljZUVycm9yO1xuICAgICAgY29uc3QgaXNSc3RTdHJlYW1Ob0Vycm9yID1cbiAgICAgICAgc2VydmljZUVycm9yLmNvZGUgPT09IFN0YXR1cy5JTlRFUk5BTCAmJlxuICAgICAgICBzZXJ2aWNlRXJyb3IuZGV0YWlscyA9PT0gUHVic3ViQ2xpZW50LlJTVF9TVFJFQU1fTk9fRVJST1JfTUVTU0FHRTtcbiAgICAgIGNvbnN0IG1vbWVudG9FcnJvciA9IG5ldyBUb3BpY1N1YnNjcmliZS5FcnJvcihcbiAgICAgICAgY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIoc2VydmljZUVycm9yKVxuICAgICAgKTtcbiAgICAgIHRoaXMuaGFuZGxlU3Vic2NyaWJlRXJyb3Iob3B0aW9ucywgbW9tZW50b0Vycm9yLCBpc1JzdFN0cmVhbU5vRXJyb3IpO1xuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBpbml0aWFsaXplVW5hcnlJbnRlcmNlcHRvcnMoXG4gICAgaGVhZGVyczogSGVhZGVyW10sXG4gICAgY29uZmlndXJhdGlvbjogVG9waWNDb25maWd1cmF0aW9uLFxuICAgIHJlcXVlc3RUaW1lb3V0TXM6IG51bWJlclxuICApOiBJbnRlcmNlcHRvcltdIHtcbiAgICByZXR1cm4gW1xuICAgICAgbWlkZGxld2FyZXNJbnRlcmNlcHRvcihjb25maWd1cmF0aW9uLmdldExvZ2dlckZhY3RvcnkoKSwgW10sIHt9KSxcbiAgICAgIG5ldyBIZWFkZXJJbnRlcmNlcHRvclByb3ZpZGVyKGhlYWRlcnMpLmNyZWF0ZUhlYWRlcnNJbnRlcmNlcHRvcigpLFxuICAgICAgQ2xpZW50VGltZW91dEludGVyY2VwdG9yKHJlcXVlc3RUaW1lb3V0TXMpLFxuICAgIF07XG4gIH1cblxuICAvLyBUT0RPIGh0dHBzOi8vZ2l0aHViLmNvbS9tb21lbnRvaHEvY2xpZW50LXNkay1ub2RlanMvaXNzdWVzLzM0OVxuICAvLyBkZWNpZGUgb24gc3RyZWFtaW5nIGludGVyY2VwdG9ycyBhbmQgbWlkZGxld2FyZXNcbiAgcHJpdmF0ZSBzdGF0aWMgaW5pdGlhbGl6ZVN0cmVhbWluZ0ludGVyY2VwdG9ycyhcbiAgICBoZWFkZXJzOiBIZWFkZXJbXVxuICApOiBJbnRlcmNlcHRvcltdIHtcbiAgICByZXR1cm4gW25ldyBIZWFkZXJJbnRlcmNlcHRvclByb3ZpZGVyKGhlYWRlcnMpLmNyZWF0ZUhlYWRlcnNJbnRlcmNlcHRvcigpXTtcbiAgfVxufVxuIl19