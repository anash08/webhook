"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ControlClient = void 0;
const generated_types_1 = require("@gomomento/generated-types");
var grpcControl = generated_types_1.control.control_client;
const headers_interceptor_1 = require("./grpc/headers-interceptor");
const client_timeout_interceptor_1 = require("./grpc/client-timeout-interceptor");
const constants_1 = require("@grpc/grpc-js/build/src/constants");
const cache_service_error_mapper_1 = require("../errors/cache-service-error-mapper");
const grpc_js_1 = require("@grpc/grpc-js");
const __1 = require("..");
const package_json_1 = require("../../package.json");
const idle_grpc_client_wrapper_1 = require("./grpc/idle-grpc-client-wrapper");
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
const errors_1 = require("@gomomento/sdk-core/dist/src/errors");
const grpc_response_types_1 = require("@gomomento/sdk-core/dist/src/messages/responses/grpc-response-types");
class ControlClient {
    /**
     * @param {ControlClientProps} props
     */
    constructor(props) {
        this.logger = props.configuration.getLoggerFactory().getLogger(this);
        const headers = [
            new headers_interceptor_1.Header('Authorization', props.credentialProvider.getAuthToken()),
            new headers_interceptor_1.Header('Agent', `nodejs:${package_json_1.version}`),
        ];
        this.interceptors = [
            new headers_interceptor_1.HeaderInterceptorProvider(headers).createHeadersInterceptor(),
            (0, client_timeout_interceptor_1.ClientTimeoutInterceptor)(ControlClient.REQUEST_TIMEOUT_MS),
        ];
        this.logger.debug(`Creating control client using endpoint: '${props.credentialProvider.getControlEndpoint()}`);
        this.clientWrapper = new idle_grpc_client_wrapper_1.IdleGrpcClientWrapper({
            clientFactoryFn: () => new grpcControl.ScsControlClient(props.credentialProvider.getControlEndpoint(), grpc_js_1.ChannelCredentials.createSsl()),
            loggerFactory: props.configuration.getLoggerFactory(),
            maxIdleMillis: props.configuration
                .getTransportStrategy()
                .getMaxIdleMillis(),
        });
    }
    async createCache(name) {
        try {
            (0, utils_1.validateCacheName)(name);
        }
        catch (err) {
            return new __1.CreateCache.Error((0, errors_1.normalizeSdkError)(err));
        }
        this.logger.info(`Creating cache: ${name}`);
        const request = new grpcControl._CreateCacheRequest({
            cache_name: name,
        });
        return await new Promise(resolve => {
            this.clientWrapper.getClient().CreateCache(request, { interceptors: this.interceptors }, 
            // eslint-disable-next-line @typescript-eslint/no-unused-vars
            (err, resp) => {
                if (err) {
                    if (err.code === constants_1.Status.ALREADY_EXISTS) {
                        resolve(new __1.CreateCache.AlreadyExists());
                    }
                    else {
                        resolve(new __1.CreateCache.Error((0, cache_service_error_mapper_1.cacheServiceErrorMapper)(err)));
                    }
                }
                else {
                    resolve(new __1.CreateCache.Success());
                }
            });
        });
    }
    async deleteCache(name) {
        try {
            (0, utils_1.validateCacheName)(name);
        }
        catch (err) {
            return new __1.DeleteCache.Error((0, errors_1.normalizeSdkError)(err));
        }
        const request = new grpcControl._DeleteCacheRequest({
            cache_name: name,
        });
        this.logger.info(`Deleting cache: ${name}`);
        return await new Promise(resolve => {
            this.clientWrapper.getClient().DeleteCache(request, { interceptors: this.interceptors }, 
            // eslint-disable-next-line @typescript-eslint/no-unused-vars
            (err, resp) => {
                if (err) {
                    resolve(new __1.DeleteCache.Error((0, cache_service_error_mapper_1.cacheServiceErrorMapper)(err)));
                }
                else {
                    resolve(new __1.DeleteCache.Success());
                }
            });
        });
    }
    async flushCache(cacheName) {
        try {
            (0, utils_1.validateCacheName)(cacheName);
        }
        catch (err) {
            return new __1.CacheFlush.Error((0, errors_1.normalizeSdkError)(err));
        }
        this.logger.trace(`Flushing cache: ${cacheName}`);
        return await this.sendFlushCache(cacheName);
    }
    async sendFlushCache(cacheName) {
        const request = new grpcControl._FlushCacheRequest({
            cache_name: cacheName,
        });
        return await new Promise(resolve => {
            this.clientWrapper.getClient().FlushCache(request, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                if (resp) {
                    resolve(new __1.CacheFlush.Success());
                }
                else {
                    resolve(new __1.CacheFlush.Error((0, cache_service_error_mapper_1.cacheServiceErrorMapper)(err)));
                }
            });
        });
    }
    async listCaches() {
        const request = new grpcControl._ListCachesRequest();
        request.next_token = '';
        this.logger.debug("Issuing 'listCaches' request");
        return await new Promise(resolve => {
            this.clientWrapper
                .getClient()
                .ListCaches(request, { interceptors: this.interceptors }, (err, resp) => {
                if (err || !resp) {
                    resolve(new __1.ListCaches.Error((0, cache_service_error_mapper_1.cacheServiceErrorMapper)(err)));
                }
                else {
                    const caches = resp.cache.map(cache => {
                        var _a, _b, _c, _d, _e, _f, _g;
                        const cacheName = cache.cache_name;
                        const topicLimits = {
                            maxPublishMessageSizeKb: ((_a = cache.topic_limits) === null || _a === void 0 ? void 0 : _a.max_publish_message_size_kb) || 0,
                            maxSubscriptionCount: ((_b = cache.topic_limits) === null || _b === void 0 ? void 0 : _b.max_subscription_count) || 0,
                            maxPublishRate: ((_c = cache.topic_limits) === null || _c === void 0 ? void 0 : _c.max_publish_rate) || 0,
                        };
                        const cacheLimits = {
                            maxTtlSeconds: ((_d = cache.cache_limits) === null || _d === void 0 ? void 0 : _d.max_ttl_seconds) || 0,
                            maxItemSizeKb: ((_e = cache.cache_limits) === null || _e === void 0 ? void 0 : _e.max_item_size_kb) || 0,
                            maxThroughputKbps: ((_f = cache.cache_limits) === null || _f === void 0 ? void 0 : _f.max_throughput_kbps) || 0,
                            maxTrafficRate: ((_g = cache.cache_limits) === null || _g === void 0 ? void 0 : _g.max_traffic_rate) || 0,
                        };
                        return new __1.CacheInfo(cacheName, topicLimits, cacheLimits);
                    });
                    resolve(new __1.ListCaches.Success(caches));
                }
            });
        });
    }
    async createSigningKey(ttlMinutes, endpoint) {
        try {
            (0, utils_1.validateTtlMinutes)(ttlMinutes);
        }
        catch (err) {
            return new __1.CreateSigningKey.Error((0, errors_1.normalizeSdkError)(err));
        }
        this.logger.debug("Issuing 'createSigningKey' request");
        const request = new grpcControl._CreateSigningKeyRequest();
        request.ttl_minutes = ttlMinutes;
        return await new Promise(resolve => {
            this.clientWrapper
                .getClient()
                .CreateSigningKey(request, { interceptors: this.interceptors }, (err, resp) => {
                if (err) {
                    resolve(new __1.CreateSigningKey.Error((0, cache_service_error_mapper_1.cacheServiceErrorMapper)(err)));
                }
                else {
                    const signingKey = new grpc_response_types_1._SigningKey(resp === null || resp === void 0 ? void 0 : resp.key, resp === null || resp === void 0 ? void 0 : resp.expires_at);
                    resolve(new __1.CreateSigningKey.Success(endpoint, signingKey));
                }
            });
        });
    }
    async revokeSigningKey(keyId) {
        const request = new grpcControl._RevokeSigningKeyRequest();
        request.key_id = keyId;
        this.logger.debug("Issuing 'revokeSigningKey' request");
        return await new Promise(resolve => {
            this.clientWrapper
                .getClient()
                .RevokeSigningKey(request, { interceptors: this.interceptors }, err => {
                if (err) {
                    resolve(new __1.RevokeSigningKey.Error((0, cache_service_error_mapper_1.cacheServiceErrorMapper)(err)));
                }
                else {
                    resolve(new __1.RevokeSigningKey.Success());
                }
            });
        });
    }
    async listSigningKeys(endpoint) {
        const request = new grpcControl._ListSigningKeysRequest();
        request.next_token = '';
        this.logger.debug("Issuing 'listSigningKeys' request");
        return await new Promise(resolve => {
            this.clientWrapper
                .getClient()
                .ListSigningKeys(request, { interceptors: this.interceptors }, (err, resp) => {
                if (err || !resp) {
                    resolve(new __1.ListSigningKeys.Error((0, cache_service_error_mapper_1.cacheServiceErrorMapper)(err)));
                }
                else {
                    const signingKeys = resp.signing_key.map(sk => new grpc_response_types_1._SigningKey(sk.key_id, sk.expires_at));
                    resolve(new __1.ListSigningKeys.Success(endpoint, signingKeys, resp.next_token));
                }
            });
        });
    }
}
exports.ControlClient = ControlClient;
ControlClient.REQUEST_TIMEOUT_MS = 60 * 1000;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbC1jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvaW50ZXJuYWwvY29udHJvbC1jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsZ0VBQW1EO0FBQ25ELElBQU8sV0FBVyxHQUFHLHlCQUFPLENBQUMsY0FBYyxDQUFDO0FBQzVDLG9FQUE2RTtBQUM3RSxrRkFBMkU7QUFDM0UsaUVBQXlEO0FBQ3pELHFGQUE2RTtBQUM3RSwyQ0FBOEQ7QUFDOUQsMEJBV1k7QUFDWixxREFBMkM7QUFDM0MsOEVBQXNFO0FBR3RFLHVFQUdxRDtBQUNyRCxnRUFBc0U7QUFDdEUsNkdBQWdHO0FBV2hHLE1BQWEsYUFBYTtJQU14Qjs7T0FFRztJQUNILFlBQVksS0FBeUI7UUFDbkMsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JFLE1BQU0sT0FBTyxHQUFHO1lBQ2QsSUFBSSw0QkFBTSxDQUFDLGVBQWUsRUFBRSxLQUFLLENBQUMsa0JBQWtCLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDcEUsSUFBSSw0QkFBTSxDQUFDLE9BQU8sRUFBRSxVQUFVLHNCQUFPLEVBQUUsQ0FBQztTQUN6QyxDQUFDO1FBQ0YsSUFBSSxDQUFDLFlBQVksR0FBRztZQUNsQixJQUFJLCtDQUF5QixDQUFDLE9BQU8sQ0FBQyxDQUFDLHdCQUF3QixFQUFFO1lBQ2pFLElBQUEscURBQXdCLEVBQUMsYUFBYSxDQUFDLGtCQUFrQixDQUFDO1NBQzNELENBQUM7UUFDRixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FDZiw0Q0FBNEMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLGtCQUFrQixFQUFFLEVBQUUsQ0FDNUYsQ0FBQztRQUNGLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxnREFBcUIsQ0FBQztZQUM3QyxlQUFlLEVBQUUsR0FB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SUFBSSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtjb250cm9sfSBmcm9tICdAZ29tb21lbnRvL2dlbmVyYXRlZC10eXBlcyc7XG5pbXBvcnQgZ3JwY0NvbnRyb2wgPSBjb250cm9sLmNvbnRyb2xfY2xpZW50O1xuaW1wb3J0IHtIZWFkZXIsIEhlYWRlckludGVyY2VwdG9yUHJvdmlkZXJ9IGZyb20gJy4vZ3JwYy9oZWFkZXJzLWludGVyY2VwdG9yJztcbmltcG9ydCB7Q2xpZW50VGltZW91dEludGVyY2VwdG9yfSBmcm9tICcuL2dycGMvY2xpZW50LXRpbWVvdXQtaW50ZXJjZXB0b3InO1xuaW1wb3J0IHtTdGF0dXN9IGZyb20gJ0BncnBjL2dycGMtanMvYnVpbGQvc3JjL2NvbnN0YW50cyc7XG5pbXBvcnQge2NhY2hlU2VydmljZUVycm9yTWFwcGVyfSBmcm9tICcuLi9lcnJvcnMvY2FjaGUtc2VydmljZS1lcnJvci1tYXBwZXInO1xuaW1wb3J0IHtDaGFubmVsQ3JlZGVudGlhbHMsIEludGVyY2VwdG9yfSBmcm9tICdAZ3JwYy9ncnBjLWpzJztcbmltcG9ydCB7XG4gIENyZWF0ZUNhY2hlLFxuICBEZWxldGVDYWNoZSxcbiAgTGlzdENhY2hlcyxcbiAgQ3JlYXRlU2lnbmluZ0tleSxcbiAgTGlzdFNpZ25pbmdLZXlzLFxuICBSZXZva2VTaWduaW5nS2V5LFxuICBDYWNoZUZsdXNoLFxuICBDcmVkZW50aWFsUHJvdmlkZXIsXG4gIE1vbWVudG9Mb2dnZXIsXG4gIENhY2hlSW5mbyxcbn0gZnJvbSAnLi4nO1xuaW1wb3J0IHt2ZXJzaW9ufSBmcm9tICcuLi8uLi9wYWNrYWdlLmpzb24nO1xuaW1wb3J0IHtJZGxlR3JwY0NsaWVudFdyYXBwZXJ9IGZyb20gJy4vZ3JwYy9pZGxlLWdycGMtY2xpZW50LXdyYXBwZXInO1xuaW1wb3J0IHtHcnBjQ2xpZW50V3JhcHBlcn0gZnJvbSAnLi9ncnBjL2dycGMtY2xpZW50LXdyYXBwZXInO1xuaW1wb3J0IHtDb25maWd1cmF0aW9ufSBmcm9tICcuLi9jb25maWcvY29uZmlndXJhdGlvbic7XG5pbXBvcnQge1xuICB2YWxpZGF0ZUNhY2hlTmFtZSxcbiAgdmFsaWRhdGVUdGxNaW51dGVzLFxufSBmcm9tICdAZ29tb21lbnRvL3Nkay1jb3JlL2Rpc3Qvc3JjL2ludGVybmFsL3V0aWxzJztcbmltcG9ydCB7bm9ybWFsaXplU2RrRXJyb3J9IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvZXJyb3JzJztcbmltcG9ydCB7X1NpZ25pbmdLZXl9IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvbWVzc2FnZXMvcmVzcG9uc2VzL2dycGMtcmVzcG9uc2UtdHlwZXMnO1xuaW1wb3J0IHtcbiAgQ2FjaGVMaW1pdHMsXG4gIFRvcGljTGltaXRzLFxufSBmcm9tICdAZ29tb21lbnRvL3Nkay1jb3JlL2Rpc3Qvc3JjL21lc3NhZ2VzL2NhY2hlLWluZm8nO1xuXG5leHBvcnQgaW50ZXJmYWNlIENvbnRyb2xDbGllbnRQcm9wcyB7XG4gIGNvbmZpZ3VyYXRpb246IENvbmZpZ3VyYXRpb247XG4gIGNyZWRlbnRpYWxQcm92aWRlcjogQ3JlZGVudGlhbFByb3ZpZGVyO1xufVxuXG5leHBvcnQgY2xhc3MgQ29udHJvbENsaWVudCB7XG4gIHByaXZhdGUgcmVhZG9ubHkgY2xpZW50V3JhcHBlcjogR3JwY0NsaWVudFdyYXBwZXI8Z3JwY0NvbnRyb2wuU2NzQ29udHJvbENsaWVudD47XG4gIHByaXZhdGUgcmVhZG9ubHkgaW50ZXJjZXB0b3JzOiBJbnRlcmNlcHRvcltdO1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBSRVFVRVNUX1RJTUVPVVRfTVM6IG51bWJlciA9IDYwICogMTAwMDtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXI6IE1vbWVudG9Mb2dnZXI7XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7Q29udHJvbENsaWVudFByb3BzfSBwcm9wc1xuICAgKi9cbiAgY29uc3RydWN0b3IocHJvcHM6IENvbnRyb2xDbGllbnRQcm9wcykge1xuICAgIHRoaXMubG9nZ2VyID0gcHJvcHMuY29uZmlndXJhdGlvbi5nZXRMb2dnZXJGYWN0b3J5KCkuZ2V0TG9nZ2VyKHRoaXMpO1xuICAgIGNvbnN0IGhlYWRlcnMgPSBbXG4gICAgICBuZXcgSGVhZGVyKCdBdXRob3JpemF0aW9uJywgcHJvcHMuY3JlZGVudGlhbFByb3ZpZGVyLmdldEF1dGhUb2tlbigpKSxcbiAgICAgIG5ldyBIZWFkZXIoJ0FnZW50JywgYG5vZGVqczoke3ZlcnNpb259YCksXG4gICAgXTtcbiAgICB0aGlzLmludGVyY2VwdG9ycyA9IFtcbiAgICAgIG5ldyBIZWFkZXJJbnRlcmNlcHRvclByb3ZpZGVyKGhlYWRlcnMpLmNyZWF0ZUhlYWRlcnNJbnRlcmNlcHRvcigpLFxuICAgICAgQ2xpZW50VGltZW91dEludGVyY2VwdG9yKENvbnRyb2xDbGllbnQuUkVRVUVTVF9USU1FT1VUX01TKSxcbiAgICBdO1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKFxuICAgICAgYENyZWF0aW5nIGNvbnRyb2wgY2xpZW50IHVzaW5nIGVuZHBvaW50OiAnJHtwcm9wcy5jcmVkZW50aWFsUHJvdmlkZXIuZ2V0Q29udHJvbEVuZHBvaW50KCl9YFxuICAgICk7XG4gICAgdGhpcy5jbGllbnRXcmFwcGVyID0gbmV3IElkbGVHcnBjQ2xpZW50V3JhcHBlcih7XG4gICAgICBjbGllbnRGYWN0b3J5Rm46ICgpID0+XG4gICAgICAgIG5ldyBncnBjQ29udHJvbC5TY3NDb250cm9sQ2xpZW50KFxuICAgICAgICAgIHByb3BzLmNyZWRlbnRpYWxQcm92aWRlci5nZXRDb250cm9sRW5kcG9pbnQoKSxcbiAgICAgICAgICBDaGFubmVsQ3JlZGVudGlhbHMuY3JlYXRlU3NsKClcbiAgICAgICAgKSxcbiAgICAgIGxvZ2dlckZhY3Rvcnk6IHByb3BzLmNvbmZpZ3VyYXRpb24uZ2V0TG9nZ2VyRmFjdG9yeSgpLFxuICAgICAgbWF4SWRsZU1pbGxpczogcHJvcHMuY29uZmlndXJhdGlvblxuICAgICAgICAuZ2V0VHJhbnNwb3J0U3RyYXRlZ3koKVxuICAgICAgICAuZ2V0TWF4SWRsZU1pbGxpcygpLFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGNyZWF0ZUNhY2hlKG5hbWU6IHN0cmluZyk6IFByb21pc2U8Q3JlYXRlQ2FjaGUuUmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgdmFsaWRhdGVDYWNoZU5hbWUobmFtZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gbmV3IENyZWF0ZUNhY2hlLkVycm9yKG5vcm1hbGl6ZVNka0Vycm9yKGVyciBhcyBFcnJvcikpO1xuICAgIH1cbiAgICB0aGlzLmxvZ2dlci5pbmZvKGBDcmVhdGluZyBjYWNoZTogJHtuYW1lfWApO1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgZ3JwY0NvbnRyb2wuX0NyZWF0ZUNhY2hlUmVxdWVzdCh7XG4gICAgICBjYWNoZV9uYW1lOiBuYW1lLFxuICAgIH0pO1xuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZTxDcmVhdGVDYWNoZS5SZXNwb25zZT4ocmVzb2x2ZSA9PiB7XG4gICAgICB0aGlzLmNsaWVudFdyYXBwZXIuZ2V0Q2xpZW50KCkuQ3JlYXRlQ2FjaGUoXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIHtpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzfSxcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby11bnVzZWQtdmFyc1xuICAgICAgICAoZXJyLCByZXNwKSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgaWYgKGVyci5jb2RlID09PSBTdGF0dXMuQUxSRUFEWV9FWElTVFMpIHtcbiAgICAgICAgICAgICAgcmVzb2x2ZShuZXcgQ3JlYXRlQ2FjaGUuQWxyZWFkeUV4aXN0cygpKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc29sdmUobmV3IENyZWF0ZUNhY2hlLkVycm9yKGNhY2hlU2VydmljZUVycm9yTWFwcGVyKGVycikpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzb2x2ZShuZXcgQ3JlYXRlQ2FjaGUuU3VjY2VzcygpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVsZXRlQ2FjaGUobmFtZTogc3RyaW5nKTogUHJvbWlzZTxEZWxldGVDYWNoZS5SZXNwb25zZT4ge1xuICAgIHRyeSB7XG4gICAgICB2YWxpZGF0ZUNhY2hlTmFtZShuYW1lKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiBuZXcgRGVsZXRlQ2FjaGUuRXJyb3Iobm9ybWFsaXplU2RrRXJyb3IoZXJyIGFzIEVycm9yKSk7XG4gICAgfVxuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgZ3JwY0NvbnRyb2wuX0RlbGV0ZUNhY2hlUmVxdWVzdCh7XG4gICAgICBjYWNoZV9uYW1lOiBuYW1lLFxuICAgIH0pO1xuICAgIHRoaXMubG9nZ2VyLmluZm8oYERlbGV0aW5nIGNhY2hlOiAke25hbWV9YCk7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlPERlbGV0ZUNhY2hlLlJlc3BvbnNlPihyZXNvbHZlID0+IHtcbiAgICAgIHRoaXMuY2xpZW50V3JhcHBlci5nZXRDbGllbnQoKS5EZWxldGVDYWNoZShcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAge2ludGVyY2VwdG9yczogdGhpcy5pbnRlcmNlcHRvcnN9LFxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVudXNlZC12YXJzXG4gICAgICAgIChlcnIsIHJlc3ApID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICByZXNvbHZlKG5ldyBEZWxldGVDYWNoZS5FcnJvcihjYWNoZVNlcnZpY2VFcnJvck1hcHBlcihlcnIpKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc29sdmUobmV3IERlbGV0ZUNhY2hlLlN1Y2Nlc3MoKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGZsdXNoQ2FjaGUoY2FjaGVOYW1lOiBzdHJpbmcpOiBQcm9taXNlPENhY2hlRmx1c2guUmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgdmFsaWRhdGVDYWNoZU5hbWUoY2FjaGVOYW1lKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiBuZXcgQ2FjaGVGbHVzaC5FcnJvcihub3JtYWxpemVTZGtFcnJvcihlcnIgYXMgRXJyb3IpKTtcbiAgICB9XG4gICAgdGhpcy5sb2dnZXIudHJhY2UoYEZsdXNoaW5nIGNhY2hlOiAke2NhY2hlTmFtZX1gKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kRmx1c2hDYWNoZShjYWNoZU5hbWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzZW5kRmx1c2hDYWNoZShcbiAgICBjYWNoZU5hbWU6IHN0cmluZ1xuICApOiBQcm9taXNlPENhY2hlRmx1c2guUmVzcG9uc2U+IHtcbiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IGdycGNDb250cm9sLl9GbHVzaENhY2hlUmVxdWVzdCh7XG4gICAgICBjYWNoZV9uYW1lOiBjYWNoZU5hbWUsXG4gICAgfSk7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgdGhpcy5jbGllbnRXcmFwcGVyLmdldENsaWVudCgpLkZsdXNoQ2FjaGUoXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIHtcbiAgICAgICAgICBpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzLFxuICAgICAgICB9LFxuICAgICAgICAoZXJyLCByZXNwKSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3ApIHtcbiAgICAgICAgICAgIHJlc29sdmUobmV3IENhY2hlRmx1c2guU3VjY2VzcygpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzb2x2ZShuZXcgQ2FjaGVGbHVzaC5FcnJvcihjYWNoZVNlcnZpY2VFcnJvck1hcHBlcihlcnIpKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGxpc3RDYWNoZXMoKTogUHJvbWlzZTxMaXN0Q2FjaGVzLlJlc3BvbnNlPiB7XG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBncnBjQ29udHJvbC5fTGlzdENhY2hlc1JlcXVlc3QoKTtcbiAgICByZXF1ZXN0Lm5leHRfdG9rZW4gPSAnJztcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhcIklzc3VpbmcgJ2xpc3RDYWNoZXMnIHJlcXVlc3RcIik7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlPExpc3RDYWNoZXMuUmVzcG9uc2U+KHJlc29sdmUgPT4ge1xuICAgICAgdGhpcy5jbGllbnRXcmFwcGVyXG4gICAgICAgIC5nZXRDbGllbnQoKVxuICAgICAgICAuTGlzdENhY2hlcyhyZXF1ZXN0LCB7aW50ZXJjZXB0b3JzOiB0aGlzLmludGVyY2VwdG9yc30sIChlcnIsIHJlc3ApID0+IHtcbiAgICAgICAgICBpZiAoZXJyIHx8ICFyZXNwKSB7XG4gICAgICAgICAgICByZXNvbHZlKG5ldyBMaXN0Q2FjaGVzLkVycm9yKGNhY2hlU2VydmljZUVycm9yTWFwcGVyKGVycikpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgY2FjaGVzID0gcmVzcC5jYWNoZS5tYXAoY2FjaGUgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBjYWNoZU5hbWUgPSBjYWNoZS5jYWNoZV9uYW1lO1xuICAgICAgICAgICAgICBjb25zdCB0b3BpY0xpbWl0czogVG9waWNMaW1pdHMgPSB7XG4gICAgICAgICAgICAgICAgbWF4UHVibGlzaE1lc3NhZ2VTaXplS2I6XG4gICAgICAgICAgICAgICAgICBjYWNoZS50b3BpY19saW1pdHM/Lm1heF9wdWJsaXNoX21lc3NhZ2Vfc2l6ZV9rYiB8fCAwLFxuICAgICAgICAgICAgICAgIG1heFN1YnNjcmlwdGlvbkNvdW50OlxuICAgICAgICAgICAgICAgICAgY2FjaGUudG9waWNfbGltaXRzPy5tYXhfc3Vic2NyaXB0aW9uX2NvdW50IHx8IDAsXG4gICAgICAgICAgICAgICAgbWF4UHVibGlzaFJhdGU6IGNhY2hlLnRvcGljX2xpbWl0cz8ubWF4X3B1Ymxpc2hfcmF0ZSB8fCAwLFxuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICBjb25zdCBjYWNoZUxpbWl0czogQ2FjaGVMaW1pdHMgPSB7XG4gICAgICAgICAgICAgICAgbWF4VHRsU2Vjb25kczogY2FjaGUuY2FjaGVfbGltaXRzPy5tYXhfdHRsX3NlY29uZHMgfHwgMCxcbiAgICAgICAgICAgICAgICBtYXhJdGVtU2l6ZUtiOiBjYWNoZS5jYWNoZV9saW1pdHM/Lm1heF9pdGVtX3NpemVfa2IgfHwgMCxcbiAgICAgICAgICAgICAgICBtYXhUaHJvdWdocHV0S2JwczogY2FjaGUuY2FjaGVfbGltaXRzPy5tYXhfdGhyb3VnaHB1dF9rYnBzIHx8IDAsXG4gICAgICAgICAgICAgICAgbWF4VHJhZmZpY1JhdGU6IGNhY2hlLmNhY2hlX2xpbWl0cz8ubWF4X3RyYWZmaWNfcmF0ZSB8fCAwLFxuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICByZXR1cm4gbmV3IENhY2hlSW5mbyhjYWNoZU5hbWUsIHRvcGljTGltaXRzLCBjYWNoZUxpbWl0cyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJlc29sdmUobmV3IExpc3RDYWNoZXMuU3VjY2VzcyhjYWNoZXMpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGNyZWF0ZVNpZ25pbmdLZXkoXG4gICAgdHRsTWludXRlczogbnVtYmVyLFxuICAgIGVuZHBvaW50OiBzdHJpbmdcbiAgKTogUHJvbWlzZTxDcmVhdGVTaWduaW5nS2V5LlJlc3BvbnNlPiB7XG4gICAgdHJ5IHtcbiAgICAgIHZhbGlkYXRlVHRsTWludXRlcyh0dGxNaW51dGVzKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiBuZXcgQ3JlYXRlU2lnbmluZ0tleS5FcnJvcihub3JtYWxpemVTZGtFcnJvcihlcnIgYXMgRXJyb3IpKTtcbiAgICB9XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoXCJJc3N1aW5nICdjcmVhdGVTaWduaW5nS2V5JyByZXF1ZXN0XCIpO1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgZ3JwY0NvbnRyb2wuX0NyZWF0ZVNpZ25pbmdLZXlSZXF1ZXN0KCk7XG4gICAgcmVxdWVzdC50dGxfbWludXRlcyA9IHR0bE1pbnV0ZXM7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlPENyZWF0ZVNpZ25pbmdLZXkuUmVzcG9uc2U+KHJlc29sdmUgPT4ge1xuICAgICAgdGhpcy5jbGllbnRXcmFwcGVyXG4gICAgICAgIC5nZXRDbGllbnQoKVxuICAgICAgICAuQ3JlYXRlU2lnbmluZ0tleShcbiAgICAgICAgICByZXF1ZXN0LFxuICAgICAgICAgIHtpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzfSxcbiAgICAgICAgICAoZXJyLCByZXNwKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgIHJlc29sdmUobmV3IENyZWF0ZVNpZ25pbmdLZXkuRXJyb3IoY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIoZXJyKSkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgY29uc3Qgc2lnbmluZ0tleSA9IG5ldyBfU2lnbmluZ0tleShyZXNwPy5rZXksIHJlc3A/LmV4cGlyZXNfYXQpO1xuICAgICAgICAgICAgICByZXNvbHZlKG5ldyBDcmVhdGVTaWduaW5nS2V5LlN1Y2Nlc3MoZW5kcG9pbnQsIHNpZ25pbmdLZXkpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmV2b2tlU2lnbmluZ0tleShcbiAgICBrZXlJZDogc3RyaW5nXG4gICk6IFByb21pc2U8UmV2b2tlU2lnbmluZ0tleS5SZXNwb25zZT4ge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgZ3JwY0NvbnRyb2wuX1Jldm9rZVNpZ25pbmdLZXlSZXF1ZXN0KCk7XG4gICAgcmVxdWVzdC5rZXlfaWQgPSBrZXlJZDtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhcIklzc3VpbmcgJ3Jldm9rZVNpZ25pbmdLZXknIHJlcXVlc3RcIik7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlPFJldm9rZVNpZ25pbmdLZXkuUmVzcG9uc2U+KHJlc29sdmUgPT4ge1xuICAgICAgdGhpcy5jbGllbnRXcmFwcGVyXG4gICAgICAgIC5nZXRDbGllbnQoKVxuICAgICAgICAuUmV2b2tlU2lnbmluZ0tleShyZXF1ZXN0LCB7aW50ZXJjZXB0b3JzOiB0aGlzLmludGVyY2VwdG9yc30sIGVyciA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgcmVzb2x2ZShuZXcgUmV2b2tlU2lnbmluZ0tleS5FcnJvcihjYWNoZVNlcnZpY2VFcnJvck1hcHBlcihlcnIpKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc29sdmUobmV3IFJldm9rZVNpZ25pbmdLZXkuU3VjY2VzcygpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGxpc3RTaWduaW5nS2V5cyhcbiAgICBlbmRwb2ludDogc3RyaW5nXG4gICk6IFByb21pc2U8TGlzdFNpZ25pbmdLZXlzLlJlc3BvbnNlPiB7XG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBncnBjQ29udHJvbC5fTGlzdFNpZ25pbmdLZXlzUmVxdWVzdCgpO1xuICAgIHJlcXVlc3QubmV4dF90b2tlbiA9ICcnO1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKFwiSXNzdWluZyAnbGlzdFNpZ25pbmdLZXlzJyByZXF1ZXN0XCIpO1xuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZTxMaXN0U2lnbmluZ0tleXMuUmVzcG9uc2U+KHJlc29sdmUgPT4ge1xuICAgICAgdGhpcy5jbGllbnRXcmFwcGVyXG4gICAgICAgIC5nZXRDbGllbnQoKVxuICAgICAgICAuTGlzdFNpZ25pbmdLZXlzKFxuICAgICAgICAgIHJlcXVlc3QsXG4gICAgICAgICAge2ludGVyY2VwdG9yczogdGhpcy5pbnRlcmNlcHRvcnN9LFxuICAgICAgICAgIChlcnIsIHJlc3ApID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIgfHwgIXJlc3ApIHtcbiAgICAgICAgICAgICAgcmVzb2x2ZShuZXcgTGlzdFNpZ25pbmdLZXlzLkVycm9yKGNhY2hlU2VydmljZUVycm9yTWFwcGVyKGVycikpKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGNvbnN0IHNpZ25pbmdLZXlzID0gcmVzcC5zaWduaW5nX2tleS5tYXAoXG4gICAgICAgICAgICAgICAgc2sgPT4gbmV3IF9TaWduaW5nS2V5KHNrLmtleV9pZCwgc2suZXhwaXJlc19hdClcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgcmVzb2x2ZShcbiAgICAgICAgICAgICAgICBuZXcgTGlzdFNpZ25pbmdLZXlzLlN1Y2Nlc3MoXG4gICAgICAgICAgICAgICAgICBlbmRwb2ludCxcbiAgICAgICAgICAgICAgICAgIHNpZ25pbmdLZXlzLFxuICAgICAgICAgICAgICAgICAgcmVzcC5uZXh0X3Rva2VuXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9KTtcbiAgfVxufVxuIl19