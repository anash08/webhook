"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ExperimentalMetricsMiddleware = exports.ExperimentalMetricsMiddlewareRequestHandler = void 0;
const data_client_1 = require("../../../internal/data-client");
const FIELD_NAMES = [
    'numActiveRequestsAtStart',
    'numActiveRequestsAtFinish',
    'requestType',
    'status',
    'startTime',
    'requestBodyTime',
    'endTime',
    'duration',
    'requestSize',
    'responseSize',
    'connectionID',
];
class ExperimentalMetricsMiddlewareRequestHandler {
    constructor(parent, logger, context) {
        this.parent = parent;
        this.logger = logger;
        this.connectionID = context[data_client_1.CONNECTION_ID_KEY];
        this.numActiveRequestsAtStart = parent.incrementActiveRequestCount();
        this.startTime = new Date().getTime();
        this.receivedResponseBody = false;
        this.receivedResponseStatus = false;
    }
    onRequestBody(request) {
        this.requestSize = request.messageLength();
        this.requestType = request.constructor.name;
        this.requestBodyTime = new Date().getTime();
        return Promise.resolve(request);
    }
    onRequestMetadata(metadata) {
        return Promise.resolve(metadata);
    }
    onResponseBody(response) {
        if (response !== null) {
            this.responseSize = response.messageLength();
        }
        else {
            this.responseSize = 0;
        }
        this.receivedResponseBody = true;
        if (this.done())
            this.recordMetrics();
        return Promise.resolve(response);
    }
    onResponseMetadata(metadata) {
        return Promise.resolve(metadata);
    }
    onResponseStatus(status) {
        this.receivedResponseStatus = true;
        this.responseStatusCode = status.code();
        if (this.done())
            this.recordMetrics();
        return Promise.resolve(status);
    }
    done() {
        return this.receivedResponseBody && this.receivedResponseStatus;
    }
    recordMetrics() {
        const endTime = new Date().getTime();
        const metrics = {
            numActiveRequestsAtStart: this.numActiveRequestsAtStart,
            numActiveRequestsAtFinish: this.parent.activeRequestCount(),
            requestType: this.requestType,
            status: this.responseStatusCode,
            startTime: this.startTime,
            requestBodyTime: this.requestBodyTime,
            endTime: endTime,
            duration: endTime - this.startTime,
            requestSize: this.requestSize,
            responseSize: this.responseSize,
            connectionID: this.connectionID,
        };
        this.emitMetrics(metrics).catch(e => 
        // eslint-disable-next-line @typescript-eslint/restrict-template-expressions
        this.logger.error(`An error occurred when trying to emit metrics: ${e}`));
        this.parent.decrementActiveRequestCount();
    }
}
exports.ExperimentalMetricsMiddlewareRequestHandler = ExperimentalMetricsMiddlewareRequestHandler;
/**
 * This middleware enables per-request client-side metrics.  This is an abstract
 * class that does not route the metrics to a specific destination; concrete subclasses
 * may store the metrics as they see fit.
 *
 * The metrics format is currently considered experimental; in a future release,
 * once the format is considered stable, this class will be renamed to remove
 * the Experimental prefix.
 *
 * WARNING: enabling this middleware may have minor performance implications,
 * so enable with caution.
 *
 * See `advanced.ts` in the examples directory for an example of how to set up
 * your {Configuration} to enable this middleware.
 */
class ExperimentalMetricsMiddleware {
    constructor(loggerFactory, requestHandlerFactoryFn) {
        this.numActiveRequests = 0;
        this.logger = loggerFactory.getLogger(this);
        this.requestHandlerFactoryFn = requestHandlerFactoryFn;
    }
    fieldNames() {
        return FIELD_NAMES;
    }
    incrementActiveRequestCount() {
        return ++this.numActiveRequests;
    }
    activeRequestCount() {
        return this.numActiveRequests;
    }
    decrementActiveRequestCount() {
        --this.numActiveRequests;
    }
    onNewRequest(context) {
        return this.requestHandlerFactoryFn(this, this.logger, context);
    }
}
exports.ExperimentalMetricsMiddleware = ExperimentalMetricsMiddleware;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwZXJpbWVudGFsLW1ldHJpY3MtbWlkZGxld2FyZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9jb25maWcvbWlkZGxld2FyZS9pbXBsL2V4cGVyaW1lbnRhbC1tZXRyaWNzLW1pZGRsZXdhcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBU0EsK0RBQWdFO0FBRWhFLE1BQU0sV0FBVyxHQUFrQjtJQUNqQywwQkFBMEI7SUFDMUIsMkJBQTJCO0lBQzNCLGFBQWE7SUFDYixRQUFRO0lBQ1IsV0FBVztJQUNYLGlCQUFpQjtJQUNqQixTQUFTO0lBQ1QsVUFBVTtJQUNWLGFBQWE7SUFDYixjQUFjO0lBQ2QsY0FBYztDQUNmLENBQUM7QUFpREYsTUFBc0IsMkNBQTJDO0lBa0IvRCxZQUNFLE1BQXFDLEVBQ3JDLE1BQXFCLEVBQ3JCLE9BQXdDO1FBRXhDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxZQUFZLEdBQUcsT0FBTyxDQUFDLCtCQUFpQixDQUFDLENBQUM7UUFFL0MsSUFBSSxDQUFDLHdCQUF3QixHQUFHLE1BQU0sQ0FBQywyQkFBMkIsRUFBRSxDQUFDO1FBQ3JFLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUV0QyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsS0FBSyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxLQUFLLENBQUM7SUFDdEMsQ0FBQztJQUlELGFBQWEsQ0FBQyxPQUEwQjtRQUN0QyxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUMzQyxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDO1FBQzVDLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFB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QUM7SUFFRCwyQkFBMkI7UUFDekIsT0FBTyxFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQztJQUNsQyxDQUFDO0lBRUQsa0JBQWtCO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDO0lBQ2hDLENBQUM7SUFFRCwyQkFBMkI7UUFDekIsRUFBRSxJQUFJLENBQUMsaUJBQWlCLENBQUM7SUFDM0IsQ0FBQztJQUVELFlBQVksQ0FDVixPQUF3QztRQUV4QyxPQUFPLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNsRSxDQUFDO0NBQ0Y7QUEzQ0Qsc0VBMkNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgTWlkZGxld2FyZSxcbiAgTWlkZGxld2FyZU1lc3NhZ2UsXG4gIE1pZGRsZXdhcmVNZXRhZGF0YSxcbiAgTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyLFxuICBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXJDb250ZXh0LFxuICBNaWRkbGV3YXJlU3RhdHVzLFxufSBmcm9tICcuLi9taWRkbGV3YXJlJztcbmltcG9ydCB7TW9tZW50b0xvZ2dlciwgTW9tZW50b0xvZ2dlckZhY3Rvcnl9IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUnO1xuaW1wb3J0IHtDT05ORUNUSU9OX0lEX0tFWX0gZnJvbSAnLi4vLi4vLi4vaW50ZXJuYWwvZGF0YS1jbGllbnQnO1xuXG5jb25zdCBGSUVMRF9OQU1FUzogQXJyYXk8c3RyaW5nPiA9IFtcbiAgJ251bUFjdGl2ZVJlcXVlc3RzQXRTdGFydCcsXG4gICdudW1BY3RpdmVSZXF1ZXN0c0F0RmluaXNoJyxcbiAgJ3JlcXVlc3RUeXBlJyxcbiAgJ3N0YXR1cycsXG4gICdzdGFydFRpbWUnLFxuICAncmVxdWVzdEJvZHlUaW1lJyxcbiAgJ2VuZFRpbWUnLFxuICAnZHVyYXRpb24nLFxuICAncmVxdWVzdFNpemUnLFxuICAncmVzcG9uc2VTaXplJyxcbiAgJ2Nvbm5lY3Rpb25JRCcsXG5dO1xuXG5leHBvcnQgaW50ZXJmYWNlIEV4cGVyaW1lbnRhbFJlcXVlc3RNZXRyaWNzIHtcbiAgLyoqXG4gICAqIG51bWJlciBvZiByZXF1ZXN0cyBhY3RpdmUgYXQgdGhlIHN0YXJ0IG9mIHRoZSByZXF1ZXN0XG4gICAqL1xuICBudW1BY3RpdmVSZXF1ZXN0c0F0U3RhcnQ6IG51bWJlcjtcbiAgLyoqXG4gICAqIG51bWJlciBvZiByZXF1ZXN0cyBhY3RpdmUgYXQgdGhlIGZpbmlzaCBvZiB0aGUgcmVxdWVzdCAoaW5jbHVkaW5nIHRoZSByZXF1ZXN0IGl0c2VsZilcbiAgICovXG4gIG51bUFjdGl2ZVJlcXVlc3RzQXRGaW5pc2g6IG51bWJlcjtcbiAgLyoqXG4gICAqIFRoZSBnZW5lcmF0ZWQgZ3JwYyBvYmplY3QgdHlwZSBvZiB0aGUgcmVxdWVzdFxuICAgKi9cbiAgcmVxdWVzdFR5cGU6IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBncnBjIHN0YXR1cyBjb2RlIG9mIHRoZSByZXNwb25zZVxuICAgKi9cbiAgc3RhdHVzOiBudW1iZXI7XG4gIC8qKlxuICAgKiBUaGUgdGltZSB0aGUgcmVxdWVzdCBzdGFydGVkIChtaWxsaXMgc2luY2UgZXBvY2gpXG4gICAqL1xuICBzdGFydFRpbWU6IG51bWJlcjtcbiAgLyoqXG4gICAqIFRoZSB0aW1lIHRoZSBib2R5IG9mIHRoZSByZXF1ZXN0IHdhcyBhdmFpbGFibGUgdG8gdGhlIGdycGMgbGlicmFyeSAobWlsbGlzIHNpbmNlIGVwb2NoKVxuICAgKi9cbiAgcmVxdWVzdEJvZHlUaW1lOiBudW1iZXI7XG4gIC8qKlxuICAgKiBUaGUgdGltZSB0aGUgcmVxdWVzdCBjb21wbGV0ZWQgKG1pbGxpcyBzaW5jZSBlcG9jaClcbiAgICovXG4gIGVuZFRpbWU6IG51bWJlcjtcbiAgLyoqXG4gICAqIFRoZSBkdXJhdGlvbiBvZiB0aGUgcmVxdWVzdCAoaW4gbWlsbGlzKVxuICAgKi9cbiAgZHVyYXRpb246IG51bWJlcjtcbiAgLyoqXG4gICAqIFRoZSBzaXplIG9mIHRoZSByZXF1ZXN0IGJvZHkgaW4gYnl0ZXNcbiAgICovXG4gIHJlcXVlc3RTaXplOiBudW1iZXI7XG4gIC8qKlxuICAgKiBUaGUgc2l6ZSBvZiB0aGUgcmVzcG9uc2UgYm9keSBpbiBieXRlc1xuICAgKi9cbiAgcmVzcG9uc2VTaXplOiBudW1iZXI7XG4gIC8qKlxuICAgKiBUaGUgSUQgb2YgdGhlIHNwZWNpZmljIGNvbm5lY3Rpb24gdGhhdCBtYWRlIHRoZSByZXF1ZXN0XG4gICAqL1xuICBjb25uZWN0aW9uSUQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEV4cGVyaW1lbnRhbE1ldHJpY3NNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXJcbiAgaW1wbGVtZW50cyBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXJcbntcbiAgcHJpdmF0ZSByZWFkb25seSBwYXJlbnQ6IEV4cGVyaW1lbnRhbE1ldHJpY3NNaWRkbGV3YXJlO1xuICBwcm90ZWN0ZWQgcmVhZG9ubHkgbG9nZ2VyOiBNb21lbnRvTG9nZ2VyO1xuICBwcml2YXRlIHJlYWRvbmx5IGNvbm5lY3Rpb25JRDogc3RyaW5nO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgbnVtQWN0aXZlUmVxdWVzdHNBdFN0YXJ0OiBudW1iZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgc3RhcnRUaW1lOiBudW1iZXI7XG4gIHByaXZhdGUgcmVxdWVzdEJvZHlUaW1lOiBudW1iZXI7XG4gIHByaXZhdGUgcmVxdWVzdFR5cGU6IHN0cmluZztcbiAgcHJpdmF0ZSByZXF1ZXN0U2l6ZTogbnVtYmVyO1xuICBwcml2YXRlIHJlc3BvbnNlU3RhdHVzQ29kZTogbnVtYmVyO1xuICBwcml2YXRlIHJlc3BvbnNlU2l6ZTogbnVtYmVyO1xuXG4gIHByaXZhdGUgcmVjZWl2ZWRSZXNwb25zZUJvZHk6IGJvb2xlYW47XG4gIHByaXZhdGUgcmVjZWl2ZWRSZXNwb25zZVN0YXR1czogYm9vbGVhbjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwYXJlbnQ6IEV4cGVyaW1lbnRhbE1ldHJpY3NNaWRkbGV3YXJlLFxuICAgIGxvZ2dlcjogTW9tZW50b0xvZ2dlcixcbiAgICBjb250ZXh0OiBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXJDb250ZXh0XG4gICkge1xuICAgIHRoaXMucGFyZW50ID0gcGFyZW50O1xuICAgIHRoaXMubG9nZ2VyID0gbG9nZ2VyO1xuICAgIHRoaXMuY29ubmVjdGlvbklEID0gY29udGV4dFtDT05ORUNUSU9OX0lEX0tFWV07XG5cbiAgICB0aGlzLm51bUFjdGl2ZVJlcXVlc3RzQXRTdGFydCA9IHBhcmVudC5pbmNyZW1lbnRBY3RpdmVSZXF1ZXN0Q291bnQoKTtcbiAgICB0aGlzLnN0YXJ0VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuXG4gICAgdGhpcy5yZWNlaXZlZFJlc3BvbnNlQm9keSA9IGZhbHNlO1xuICAgIHRoaXMucmVjZWl2ZWRSZXNwb25zZVN0YXR1cyA9IGZhbHNlO1xuICB9XG5cbiAgYWJzdHJhY3QgZW1pdE1ldHJpY3MobWV0cmljczogRXhwZXJpbWVudGFsUmVxdWVzdE1ldHJpY3MpOiBQcm9taXNlPHZvaWQ+O1xuXG4gIG9uUmVxdWVzdEJvZHkocmVxdWVzdDogTWlkZGxld2FyZU1lc3NhZ2UpOiBQcm9taXNlPE1pZGRsZXdhcmVNZXNzYWdlPiB7XG4gICAgdGhpcy5yZXF1ZXN0U2l6ZSA9IHJlcXVlc3QubWVzc2FnZUxlbmd0aCgpO1xuICAgIHRoaXMucmVxdWVzdFR5cGUgPSByZXF1ZXN0LmNvbnN0cnVjdG9yLm5hbWU7XG4gICAgdGhpcy5yZXF1ZXN0Qm9keVRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlcXVlc3QpO1xuICB9XG5cbiAgb25SZXF1ZXN0TWV0YWRhdGEobWV0YWRhdGE6IE1pZGRsZXdhcmVNZXRhZGF0YSk6IFByb21pc2U8TWlkZGxld2FyZU1ldGFkYXRhPiB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShtZXRhZGF0YSk7XG4gIH1cblxuICBvblJlc3BvbnNlQm9keShcbiAgICByZXNwb25zZTogTWlkZGxld2FyZU1lc3NhZ2UgfCBudWxsXG4gICk6IFByb21pc2U8TWlkZGxld2FyZU1lc3NhZ2UgfCBudWxsPiB7XG4gICAgaWYgKHJlc3BvbnNlICE9PSBudWxsKSB7XG4gICAgICB0aGlzLnJlc3BvbnNlU2l6ZSA9IHJlc3BvbnNlLm1lc3NhZ2VMZW5ndGgoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5yZXNwb25zZVNpemUgPSAwO1xuICAgIH1cbiAgICB0aGlzLnJlY2VpdmVkUmVzcG9uc2VCb2R5ID0gdHJ1ZTtcbiAgICBpZiAodGhpcy5kb25lKCkpIHRoaXMucmVjb3JkTWV0cmljcygpO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzcG9uc2UpO1xuICB9XG5cbiAgb25SZXNwb25zZU1ldGFkYXRhKFxuICAgIG1ldGFkYXRhOiBNaWRkbGV3YXJlTWV0YWRhdGFcbiAgKTogUHJvbWlzZTxNaWRkbGV3YXJlTWV0YWRhdGE+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG1ldGFkYXRhKTtcbiAgfVxuXG4gIG9uUmVzcG9uc2VTdGF0dXMoc3RhdHVzOiBNaWRkbGV3YXJlU3RhdHVzKTogUHJvbWlzZTxNaWRkbGV3YXJlU3RhdHVzPiB7XG4gICAgdGhpcy5yZWNlaXZlZFJlc3BvbnNlU3RhdHVzID0gdHJ1ZTtcbiAgICB0aGlzLnJlc3BvbnNlU3RhdHVzQ29kZSA9IHN0YXR1cy5jb2RlKCk7XG4gICAgaWYgKHRoaXMuZG9uZSgpKSB0aGlzLnJlY29yZE1ldHJpY3MoKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHN0YXR1cyk7XG4gIH1cblxuICBwcml2YXRlIGRvbmUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMucmVjZWl2ZWRSZXNwb25zZUJvZHkgJiYgdGhpcy5yZWNlaXZlZFJlc3BvbnNlU3RhdHVzO1xuICB9XG5cbiAgcHJpdmF0ZSByZWNvcmRNZXRyaWNzKCk6IHZvaWQge1xuICAgIGNvbnN0IGVuZFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICBjb25zdCBtZXRyaWNzOiBFeHBlcmltZW50YWxSZXF1ZXN0TWV0cmljcyA9IHtcbiAgICAgIG51bUFjdGl2ZVJlcXVlc3RzQXRTdGFydDogdGhpcy5udW1BY3RpdmVSZXF1ZXN0c0F0U3RhcnQsXG4gICAgICBudW1BY3RpdmVSZXF1ZXN0c0F0RmluaXNoOiB0aGlzLnBhcmVudC5hY3RpdmVSZXF1ZXN0Q291bnQoKSxcbiAgICAgIHJlcXVlc3RUeXBlOiB0aGlzLnJlcXVlc3RUeXBlLFxuICAgICAgc3RhdHVzOiB0aGlzLnJlc3BvbnNlU3RhdHVzQ29kZSxcbiAgICAgIHN0YXJ0VGltZTogdGhpcy5zdGFydFRpbWUsXG4gICAgICByZXF1ZXN0Qm9keVRpbWU6IHRoaXMucmVxdWVzdEJvZHlUaW1lLFxuICAgICAgZW5kVGltZTogZW5kVGltZSxcbiAgICAgIGR1cmF0aW9uOiBlbmRUaW1lIC0gdGhpcy5zdGFydFRpbWUsXG4gICAgICByZXF1ZXN0U2l6ZTogdGhpcy5yZXF1ZXN0U2l6ZSxcbiAgICAgIHJlc3BvbnNlU2l6ZTogdGhpcy5yZXNwb25zZVNpemUsXG4gICAgICBjb25uZWN0aW9uSUQ6IHRoaXMuY29ubmVjdGlvbklELFxuICAgIH07XG4gICAgdGhpcy5lbWl0TWV0cmljcyhtZXRyaWNzKS5jYXRjaChlID0+XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L3Jlc3RyaWN0LXRlbXBsYXRlLWV4cHJlc3Npb25zXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgQW4gZXJyb3Igb2NjdXJyZWQgd2hlbiB0cnlpbmcgdG8gZW1pdCBtZXRyaWNzOiAke2V9YClcbiAgICApO1xuICAgIHRoaXMucGFyZW50LmRlY3JlbWVudEFjdGl2ZVJlcXVlc3RDb3VudCgpO1xuICB9XG59XG5cbi8qKlxuICogVGhpcyBtaWRkbGV3YXJlIGVuYWJsZXMgcGVyLXJlcXVlc3QgY2xpZW50LXNpZGUgbWV0cmljcy4gIFRoaXMgaXMgYW4gYWJzdHJhY3RcbiAqIGNsYXNzIHRoYXQgZG9lcyBub3Qgcm91dGUgdGhlIG1ldHJpY3MgdG8gYSBzcGVjaWZpYyBkZXN0aW5hdGlvbjsgY29uY3JldGUgc3ViY2xhc3Nlc1xuICogbWF5IHN0b3JlIHRoZSBtZXRyaWNzIGFzIHRoZXkgc2VlIGZpdC5cbiAqXG4gKiBUaGUgbWV0cmljcyBmb3JtYXQgaXMgY3VycmVudGx5IGNvbnNpZGVyZWQgZXhwZXJpbWVudGFsOyBpbiBhIGZ1dHVyZSByZWxlYXNlLFxuICogb25jZSB0aGUgZm9ybWF0IGlzIGNvbnNpZGVyZWQgc3RhYmxlLCB0aGlzIGNsYXNzIHdpbGwgYmUgcmVuYW1lZCB0byByZW1vdmVcbiAqIHRoZSBFeHBlcmltZW50YWwgcHJlZml4LlxuICpcbiAqIFdBUk5JTkc6IGVuYWJsaW5nIHRoaXMgbWlkZGxld2FyZSBtYXkgaGF2ZSBtaW5vciBwZXJmb3JtYW5jZSBpbXBsaWNhdGlvbnMsXG4gKiBzbyBlbmFibGUgd2l0aCBjYXV0aW9uLlxuICpcbiAqIFNlZSBgYWR2YW5jZWQudHNgIGluIHRoZSBleGFtcGxlcyBkaXJlY3RvcnkgZm9yIGFuIGV4YW1wbGUgb2YgaG93IHRvIHNldCB1cFxuICogeW91ciB7Q29uZmlndXJhdGlvbn0gdG8gZW5hYmxlIHRoaXMgbWlkZGxld2FyZS5cbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEV4cGVyaW1lbnRhbE1ldHJpY3NNaWRkbGV3YXJlIGltcGxlbWVudHMgTWlkZGxld2FyZSB7XG4gIHByaXZhdGUgbnVtQWN0aXZlUmVxdWVzdHMgPSAwO1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlcjogTW9tZW50b0xvZ2dlcjtcblxuICBwcml2YXRlIHJlYWRvbmx5IHJlcXVlc3RIYW5kbGVyRmFjdG9yeUZuOiAoXG4gICAgcGFyZW50OiBFeHBlcmltZW50YWxNZXRyaWNzTWlkZGxld2FyZSxcbiAgICBsb2dnZXI6IE1vbWVudG9Mb2dnZXIsXG4gICAgY29udGV4dDogTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyQ29udGV4dFxuICApID0+IE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBsb2dnZXJGYWN0b3J5OiBNb21lbnRvTG9nZ2VyRmFjdG9yeSxcbiAgICByZXF1ZXN0SGFuZGxlckZhY3RvcnlGbjogKFxuICAgICAgcGFyZW50OiBFeHBlcmltZW50YWxNZXRyaWNzTWlkZGxld2FyZSxcbiAgICAgIGxvZ2dlcjogTW9tZW50b0xvZ2dlcixcbiAgICAgIGNvbnRleHQ6IE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlckNvbnRleHRcbiAgICApID0+IE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlclxuICApIHtcbiAgICB0aGlzLmxvZ2dlciA9IGxvZ2dlckZhY3RvcnkuZ2V0TG9nZ2VyKHRoaXMpO1xuICAgIHRoaXMucmVxdWVzdEhhbmRsZXJGYWN0b3J5Rm4gPSByZXF1ZXN0SGFuZGxlckZhY3RvcnlGbjtcbiAgfVxuXG4gIGZpZWxkTmFtZXMoKTogQXJyYXk8c3RyaW5nPiB7XG4gICAgcmV0dXJuIEZJRUxEX05BTUVTO1xuICB9XG5cbiAgaW5jcmVtZW50QWN0aXZlUmVxdWVzdENvdW50KCk6IG51bWJlciB7XG4gICAgcmV0dXJuICsrdGhpcy5udW1BY3RpdmVSZXF1ZXN0cztcbiAgfVxuXG4gIGFjdGl2ZVJlcXVlc3RDb3VudCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLm51bUFjdGl2ZVJlcXVlc3RzO1xuICB9XG5cbiAgZGVjcmVtZW50QWN0aXZlUmVxdWVzdENvdW50KCk6IHZvaWQge1xuICAgIC0tdGhpcy5udW1BY3RpdmVSZXF1ZXN0cztcbiAgfVxuXG4gIG9uTmV3UmVxdWVzdChcbiAgICBjb250ZXh0OiBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXJDb250ZXh0XG4gICk6IE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlciB7XG4gICAgcmV0dXJuIHRoaXMucmVxdWVzdEhhbmRsZXJGYWN0b3J5Rm4odGhpcywgdGhpcy5sb2dnZXIsIGNvbnRleHQpO1xuICB9XG59XG4iXX0=